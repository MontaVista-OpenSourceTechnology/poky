From 6c51adeb71da076c5c40a45e339e06bb4394a86b Mon Sep 17 00:00:00 2001
From: Eric Vigeant <evigeant@gmail.com>
Date: Wed, 2 Nov 2022 11:47:09 -0400
Subject: [PATCH] cur_path: do not add '/' if homedir ends with one

When using SFTP and a path relative to the user home, do not add a
trailing '/' to the user home dir if it already ends with one.

Closes #9844

Upstream-Status: Backport [https://github.com/curl/curl/commit/6c51adeb71da076c5c40a45e339e06bb4394a86b]
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/curl_path.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- a/lib/curl_path.c
+++ b/lib/curl_path.c
@@ -68,10 +68,14 @@ CURLcode Curl_getworkingpath(struct conn
       /* It is referenced to the home directory, so strip the
          leading '/' */
       memcpy(real_path, homedir, homelen);
-      real_path[homelen] = '/';
-      real_path[homelen + 1] = '\0';
+      /* Only add a trailing '/' if homedir does not end with one */
+      if(homelen == 0 || real_path[homelen - 1] != '/') {
+        real_path[homelen] = '/';
+        homelen++;
+        real_path[homelen] = '\0';
+      }
       if(working_path_len > 3) {
-        memcpy(real_path + homelen + 1, working_path + 3,
+        memcpy(real_path + homelen, working_path + 3,
                1 + working_path_len -3);
       }
     }
