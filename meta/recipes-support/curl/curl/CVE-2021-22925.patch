From 05703e803341e98ded3963557e396ea5b2d34c41 Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Wed, 4 Jan 2023 05:12:54 +0000
Subject: [PATCH] CVE-2021-22925

---
 lib/telnet.c | 17 +++++++++++------
 1 file changed, 11 insertions(+), 6 deletions(-)

diff --git a/lib/telnet.c b/lib/telnet.c
index 48b134e..3661219 100644
--- a/lib/telnet.c
+++ b/lib/telnet.c
@@ -971,12 +971,17 @@ static void suboption(struct connectdata *conn)
         tmplen = (strlen(v->data) + 1);
         /* Add the variable only if it fits */
         if(len + tmplen < (int)sizeof(temp)-6) {
-          if(sscanf(v->data, "%127[^,],%127s", varname, varval)) {
-            snprintf((char *)&temp[len], sizeof(temp) - len,
-                     "%c%s%c%s", CURL_NEW_ENV_VAR, varname,
-                     CURL_NEW_ENV_VALUE, varval);
-            len += tmplen;
-          }
+           int rv;
+           char sep[2] = "";
+           varval[0] = 0;
+           rv = sscanf(v->data, "%127[^,]%1[,]%127s", varname, sep, varval);
+           if(rv == 1)
+              len += msnprintf((char *)&temp[len], sizeof(temp) - len,
+                             "%c%s", CURL_NEW_ENV_VAR, varname);
+           else if(rv >= 2)
+              len += msnprintf((char *)&temp[len], sizeof(temp) - len,
+                             "%c%s%c%s", CURL_NEW_ENV_VAR, varname,
+                              CURL_NEW_ENV_VALUE, varval);
         }
       }
       snprintf((char *)&temp[len], sizeof(temp) - len,
-- 
2.18.2

