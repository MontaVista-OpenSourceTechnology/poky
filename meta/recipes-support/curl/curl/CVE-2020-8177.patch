From fe39f0136511c9f822fc0cc149e2108a2ef8871f Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Tue, 13 Jul 2021 10:46:16 +0530
Subject: [PATCH] tool_getparam: -i is not OK if -J is used

Reported-by: sn on hackerone
Bug: https://curl.haxx.se/docs/CVE-2020-8177.html

Upstream-Status: Backport
CVE: CVE-2020-8177
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 src/tool_cb_hdr.c   | 5 +++++
 src/tool_getparam.c | 5 +++++
 2 files changed, 10 insertions(+)

diff --git a/src/tool_cb_hdr.c b/src/tool_cb_hdr.c
index 7f2181f..37b0225 100644
--- a/src/tool_cb_hdr.c
+++ b/src/tool_cb_hdr.c
@@ -119,6 +119,11 @@ size_t tool_header_cb(char *ptr, size_t size, size_t nmemb, void *userdata)
       len = (ssize_t)cb - (p - str);
       filename = parse_filename(p, len);
       if(filename) {
+        if(outs->stream) {
+         /* indication of problem, get out! */
+         free(filename);
+         return failure;
+        }
         outs->filename = filename;
         outs->alloc_filename = TRUE;
         outs->is_cd_filename = TRUE;
diff --git a/src/tool_getparam.c b/src/tool_getparam.c
index 3f40464..b7b39eb 100644
--- a/src/tool_getparam.c
+++ b/src/tool_getparam.c
@@ -1704,6 +1704,11 @@ ParameterError getparameter(const char *flag, /* f or -long-flag */
       }
       break;
     case 'i':
+      if(config->content_disposition) {
+        warnf(global,
+              "--include and --remote-header-name cannot be combined.\n");
+        return PARAM_BAD_USE;
+      }
       config->include_headers = toggle; /* include the headers as well in the
                                            general output stream */
       break;
-- 
2.7.4

