From 8737fd26611d74142f13ec9ef498924499e151f0 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 22 Feb 2023 05:49:47 +0000
Subject: [PATCH] smb/telnet: do not free the protocol struct in *_done()

It is managed by the generic layer.

Reported-by: Trail of Bits

Closes #10112

Upstream-Status: Backport [https://github.com/curl/curl/commit/4f20188ac644afe174be6005ef4f6ffba232b8b2]
CVE: CVE-2022-43552
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/smb.c    | 19 ++-----------------
 lib/telnet.c |  3 ---
 2 files changed, 2 insertions(+), 20 deletions(-)

diff --git a/lib/smb.c b/lib/smb.c
index 6cb4083..34db3e3 100644
--- a/lib/smb.c
+++ b/lib/smb.c
@@ -60,8 +60,6 @@ static CURLcode smb_setup_connection(struct connectdata *conn);
 static CURLcode smb_connect(struct connectdata *conn, bool *done);
 static CURLcode smb_connection_state(struct connectdata *conn, bool *done);
 static CURLcode smb_request_state(struct connectdata *conn, bool *done);
-static CURLcode smb_done(struct connectdata *conn, CURLcode status,
-                         bool premature);
 static CURLcode smb_disconnect(struct connectdata *conn, bool dead);
 static int smb_getsock(struct connectdata *conn, curl_socket_t *socks,
                        int numsocks);
@@ -74,7 +72,7 @@ const struct Curl_handler Curl_handler_smb = {
   "SMB",                                /* scheme */
   smb_setup_connection,                 /* setup_connection */
   ZERO_NULL,                            /* do_it */
-  smb_done,                             /* done */
+  ZERO_NULL,                            /* done */
   ZERO_NULL,                            /* do_more */
   smb_connect,                          /* connect_it */
   smb_connection_state,                 /* connecting */
@@ -99,7 +97,7 @@ const struct Curl_handler Curl_handler_smbs = {
   "SMBS",                               /* scheme */
   smb_setup_connection,                 /* setup_connection */
   ZERO_NULL,                            /* do_it */
-  smb_done,                             /* done */
+  ZERO_NULL,                            /* done */
   ZERO_NULL,                            /* do_more */
   smb_connect,                          /* connect_it */
   smb_connection_state,                 /* connecting */
@@ -894,19 +892,6 @@ static CURLcode smb_request_state(struct connectdata *conn, bool *done)
   return CURLE_OK;
 }
 
-static CURLcode smb_done(struct connectdata *conn, CURLcode status,
-                         bool premature)
-{
-  struct smb_request *req = conn->data->req.protop;
-
-  (void) premature;
-
-  Curl_safefree(req->share);
-  Curl_safefree(conn->data->req.protop);
-
-  return status;
-}
-
 static CURLcode smb_disconnect(struct connectdata *conn, bool dead)
 {
   struct smb_conn *smbc = &conn->proto.smbc;
diff --git a/lib/telnet.c b/lib/telnet.c
index 3661219..ed86386 100644
--- a/lib/telnet.c
+++ b/lib/telnet.c
@@ -1298,9 +1298,6 @@ static CURLcode telnet_done(struct connectdata *conn,
 
   curl_slist_free_all(tn->telnet_vars);
   tn->telnet_vars = NULL;
-
-  Curl_safefree(conn->data->req.protop);
-
   return CURLE_OK;
 }
 
-- 
2.18.2

