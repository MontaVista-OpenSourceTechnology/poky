From f446258f0269a62289cca0210157cb8558d0edc3 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Tue, 16 May 2023 23:40:42 +0200
Subject: [PATCH] hostip: include easy_lock.h before using GLOBAL_INIT_IS_THREADSAFE

Since that header file is the only place that define can be defined.

Reported-by: Marc Deslauriers

Follow-up to 13718030ad4b3209

Closes #11121

Upstream-Status: Backport [https://github.com/curl/curl/commit/f446258f0269a62289cca0210157cb8558d0edc3]
CVE: CVE-2023-28320 #Follow-up patch
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/hostip.c | 10 ++++------
 lib/hostip.h |  9 ---------
 2 files changed, 4 insertions(+), 15 deletions(-)

diff --git a/lib/hostip.c b/lib/hostip.c
index 59538a8..f69d49c 100644
--- a/lib/hostip.c
+++ b/lib/hostip.c
@@ -64,6 +64,8 @@
 #include "curl_memory.h"
 #include "memdebug.h"
 
+#include "easy_lock.h"
+
 #if defined(CURLRES_SYNCH) &&                   \
   defined(HAVE_ALARM) &&                        \
   defined(SIGALRM) &&                           \
@@ -73,10 +75,6 @@
 #define USE_ALARM_TIMEOUT
 #endif
 
-#ifdef USE_ALARM_TIMEOUT
-#include "easy_lock.h"
-#endif
-
 /*
  * hostip.c explained
  * ==================
@@ -291,8 +289,8 @@ void Curl_hostcache_prune(struct Curl_easy *data)
 /* Beware this is a global and unique instance. This is used to store the
    return address that we can jump back to from inside a signal handler. This
    is not thread-safe stuff. */
-sigjmp_buf curl_jmpenv;
-curl_simple_lock curl_jmpenv_lock;
+static sigjmp_buf curl_jmpenv;
+static curl_simple_lock curl_jmpenv_lock;
 #endif
 
 /* lookup address, returns entry if found and not stale */
diff --git a/lib/hostip.h b/lib/hostip.h
index 298eeee..2d18408 100644
--- a/lib/hostip.h
+++ b/lib/hostip.h
@@ -197,15 +197,6 @@ Curl_cache_addr(struct Curl_easy *data, Curl_addrinfo *addr,
 #define CURL_INADDR_NONE INADDR_NONE
 #endif
 
-#ifdef HAVE_SIGSETJMP
-/* Forward-declaration of variable defined in hostip.c. Beware this
- * is a global and unique instance. This is used to store the return
- * address that we can jump back to from inside a signal handler.
- * This is not thread-safe stuff.
- */
-extern sigjmp_buf curl_jmpenv;
-#endif
-
 /*
  * Function provided by the resolver backend to set DNS servers to use.
  */
-- 
2.18.2

