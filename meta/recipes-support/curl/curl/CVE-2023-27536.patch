From 288e920d8ff9ed8d9e02c581de43c137d67b76c0 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Fri, 10 Mar 2023 09:22:43 +0100
Subject: [PATCH] url: only reuse connections with same GSS delegation

Reported-by: Harry Sintonen
Closes #10731

Upstream-Status: Backport [https://github.com/curl/curl/commit/cb49e67303dbafbab1cebf4086e3ec15b7d56ee5]
CVE: CVE-2023-27536
Signed-off-by: Shubham Kulkarni <skulkarni@mvista.com>
---
 lib/url.c     | 6 ++++++
 lib/urldata.h | 1 +
 2 files changed, 7 insertions(+)

diff --git a/lib/url.c b/lib/url.c
index 0d65041..9b0cffd 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -1216,6 +1216,11 @@ ConnectionExists(struct Curl_easy *data,
         continue;
 #endif

+      /* GSS delegation differences do not actually affect every connection
+         and auth method, but this check takes precaution before efficiency */
+      if(needle->gssapi_delegation != check->gssapi_delegation)
+        continue;
+
       if((needle->handler->flags&PROTOPT_SSL) !=
          (check->handler->flags&PROTOPT_SSL))
         /* don't do mixed SSL and non-SSL connections */
@@ -1936,6 +1941,7 @@ static struct connectdata *allocate_conn(struct Curl_easy *data)
      it may live on without (this specific) Curl_easy */
   conn->fclosesocket = data->set.fclosesocket;
   conn->closesocket_client = data->set.closesocket_client;
+  conn->gssapi_delegation = data->set.gssapi_delegation;

   return conn;
   error:
diff --git a/lib/urldata.h b/lib/urldata.h
index f1241f7..ed58d0d 100644
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -1014,6 +1014,7 @@ struct connectdata {
   struct http_connect_state *connect_state; /* for HTTP CONNECT */
   struct connectbundle *bundle; /* The bundle we are member of */
   int negnpn; /* APLN or NPN TLS negotiated protocol, CURL_HTTP_VERSION* */
+  unsigned char gssapi_delegation; /* inherited from set.gssapi_delegation */

 #ifdef USE_UNIX_SOCKETS
   char *unix_domain_socket;
--
2.7.4
