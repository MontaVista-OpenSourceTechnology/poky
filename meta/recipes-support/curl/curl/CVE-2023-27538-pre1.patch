From fb8fbbd9cb6ff0dbc319679e548260b59b88dce0 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Fri, 14 Apr 2023 09:55:12 +0000
Subject: [PATCH] CVE-2023-27538-pre1

Upstream-Status: Backport [import from ubuntu https://git.launchpad.net/ubuntu/+source/curl/tree/debian/patches/CVE-2022-27782.patch?h=ubuntu/bionic-security
Upstream commit https://github.com/curl/curl/commit/1645e9b44505abd5cbaf65da5282c3f33b5924a5]
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/url.c     | 27 +++++++++++++++------------
 lib/urldata.h |  1 +
 2 files changed, 16 insertions(+), 12 deletions(-)

diff --git a/lib/url.c b/lib/url.c
index 8b4b3d6..a368a66 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -986,6 +986,12 @@ struct prunedead {
   struct connectdata *extracted;
 };
 
+static bool ssh_config_matches(struct connectdata *one,
+                               struct connectdata *two)
+{
+  return (Curl_safecmp(one->proto.sshc.rsa, two->proto.sshc.rsa) &&
+	  Curl_safecmp(one->proto.sshc.rsa_pub, two->proto.sshc.rsa_pub));
+}
 /*
  * Wrapper to use extract_if_dead() function in Curl_conncache_foreach()
  *
@@ -1031,12 +1037,6 @@ static size_t max_pipeline_length(struct Curl_multi *multi)
 }
 
 
-static bool ssh_config_matches(struct connectdata *one,
-                               struct connectdata *two)
-{
-  return (Curl_safecmp(one->proto.sshc.rsa, two->proto.sshc.rsa) &&
-          Curl_safecmp(one->proto.sshc.rsa_pub, two->proto.sshc.rsa_pub));
-}
 /*
  * Given one filled in connection struct (named needle), this function should
  * detect if there already is one that has all the significant details
@@ -1213,6 +1213,11 @@ ConnectionExists(struct Curl_easy *data,
         continue;
 #endif
 
+      if(get_protocol_family(needle->handler->protocol) == PROTO_FAMILY_SSH) {
+        if(!ssh_config_matches(needle, check))
+          continue;
+      }
+
       if((needle->handler->flags&PROTOPT_SSL) !=
          (check->handler->flags&PROTOPT_SSL))
         /* don't do mixed SSL and non-SSL connections */
@@ -1306,11 +1311,6 @@ ConnectionExists(struct Curl_easy *data,
         }
       }
 
-      if(needle->handler->protocol & (CURLPROTO_SCP|CURLPROTO_SFTP)) {
-        if(!ssh_config_matches(needle, check))
-          continue;
-      }
-
       if(!needle->bits.httpproxy || (needle->handler->flags&PROTOPT_SSL) ||
          needle->bits.tunnel_proxy) {
         /* The requested connection does not use a HTTP proxy or it uses SSL or
@@ -1890,12 +1890,15 @@ static struct connectdata *allocate_conn(struct Curl_easy *data)
   conn->ssl_config.verifypeer = data->set.ssl.primary.verifypeer;
   conn->ssl_config.verifyhost = data->set.ssl.primary.verifyhost;
   conn->ssl_config.ssl_options = data->set.ssl.primary.ssl_options;
+#ifdef USE_TLS_SRP
+#endif
   conn->proxy_ssl_config.verifystatus =
     data->set.proxy_ssl.primary.verifystatus;
   conn->proxy_ssl_config.verifypeer = data->set.proxy_ssl.primary.verifypeer;
   conn->proxy_ssl_config.verifyhost = data->set.proxy_ssl.primary.verifyhost;
   conn->proxy_ssl_config.ssl_options = data->set.proxy_ssl.primary.ssl_options;
-
+#ifdef USE_TLS_SRP
+#endif
   conn->ip_version = data->set.ipver;
 
 #if !defined(CURL_DISABLE_HTTP) && defined(USE_NTLM) && \
diff --git a/lib/urldata.h b/lib/urldata.h
index 6ab4250..652d418 100644
--- a/lib/urldata.h
+++ b/lib/urldata.h
@@ -68,6 +68,7 @@
 #define PROTO_FAMILY_POP3 (CURLPROTO_POP3|CURLPROTO_POP3S)
 #define PROTO_FAMILY_SMB  (CURLPROTO_SMB|CURLPROTO_SMBS)
 #define PROTO_FAMILY_SMTP (CURLPROTO_SMTP|CURLPROTO_SMTPS)
+#define PROTO_FAMILY_SSH  (CURLPROTO_SCP|CURLPROTO_SFTP)
 
 #define DEFAULT_CONNCACHE_SIZE 5
 
-- 
2.18.2

