From 3db352734472d851318944db13be73da61300568 Mon Sep 17 00:00:00 2001
From: Daiki Ueno <ueno@gnu.org>
Date: Wed, 22 Dec 2021 09:12:25 +0100
Subject: [PATCH] wrap_nettle_hash_fast: avoid calling _update with zero-length
 input

As Nettle's hash update functions internally call memcpy, providing
zero-length input may cause undefined behavior.

Signed-off-by: Daiki Ueno <ueno@gnu.org>

Upstream-Status: Backport
CVE: CVE-2021-4209
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 lib/nettle/mac.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

Index: gnutls-3.6.7/lib/nettle/mac.c
===================================================================
--- gnutls-3.6.7.orig/lib/nettle/mac.c
+++ gnutls-3.6.7/lib/nettle/mac.c
@@ -585,7 +585,9 @@ static int wrap_nettle_hash_fast(gnutls_
 	if (ret < 0)
 		return gnutls_assert_val(ret);
 
-	ctx.update(&ctx, text_size, text);
+	if (text_size > 0) {
+		ctx.update(&ctx, text_size, text);
+	}
 	ctx.digest(&ctx, ctx.length, digest);
 
 	return 0;
