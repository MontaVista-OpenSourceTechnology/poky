From 9f85bf693426c7ec4012b22fa2418e7482131bb3 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 3 Feb 2022 11:01:27 +0530
Subject: [PATCH] CVE-2021-4166

Upstream-Status: Backport from https://github.com/vim/vim/commit/6f98371532fcff911b462d51bc64f2ce8a6ae682

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/arglist.c                | 7 +++++++
 src/testdir/test_arglist.vim | 7 +++++++
 src/version.c                | 2 ++
 3 files changed, 16 insertions(+)

diff --git a/src/arglist.c b/src/arglist.c
index b1a6a0b2f..51c4a5836 100644
--- a/src/arglist.c
+++ b/src/arglist.c
@@ -17,6 +17,10 @@
 #define AL_ADD	2
 #define AL_DEL	3
 
+// This flag is set whenever the argument list is being changed and calling a
+// function that might trigger an autocommand.
+static int arglist_locked = FALSE;
+
 /*
  * Clear an argument list: free all file names and reset it to zero entries.
  */
@@ -874,6 +878,7 @@ do_arg_all(
     tabpage_T	*old_curtab, *last_curtab;
     win_T	*new_curwin = NULL;
     tabpage_T	*new_curtab = NULL;
+    int		prev_arglist_locked = arglist_locked;
 
     if (ARGCOUNT <= 0)
     {
@@ -893,6 +898,7 @@ do_arg_all(
     // watch out for its size to be changed.
     alist = curwin->w_alist;
     ++alist->al_refcount;
+    arglist_locked = TRUE;
 
     old_curwin = curwin;
     old_curtab = curtab;
@@ -1104,6 +1110,7 @@ do_arg_all(
 
     // Remove the "lock" on the argument list.
     alist_unlink(alist);
+    arglist_locked = prev_arglist_locked;
 
     --autocmd_no_enter;
 
diff --git a/src/testdir/test_arglist.vim b/src/testdir/test_arglist.vim
index c486b18e2..1c94fe915 100644
--- a/src/testdir/test_arglist.vim
+++ b/src/testdir/test_arglist.vim
@@ -505,3 +505,10 @@ func Test_argdo()
   call assert_equal(['Xa.c', 'Xb.c', 'Xc.c'], l)
   bwipe Xa.c Xb.c Xc.c
 endfunc
+
+func Test_clear_arglist_in_all()
+  n 0 00 000 0000 00000 000000
+  au! * 0 n 0
+  all
+  au! *
+endfunc
diff --git a/src/version.c b/src/version.c
index 46a06a345..0e684dfec 100644
--- a/src/version.c
+++ b/src/version.c
@@ -742,6 +742,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    3412,
 /**/
     3411,
 /**/
-- 
2.25.1

