From 87b411c40a89606768543703150e0a121f4d2cc6 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 2 May 2022 10:36:25 +0530
Subject: [PATCH] CVE-2022-1420

Upstream-Status: Backport from https://github.com/vim/vim/commit/8b91e71441069b1dde9ac9ff9d9a829b1b4aecca

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 src/errors.h                |  5 +++++
 src/eval.c                  | 16 ++++++++++------
 src/testdir/test_lambda.vim |  4 ++++
 src/version.c               |  2 ++
 4 files changed, 21 insertions(+), 6 deletions(-)

diff --git a/src/errors.h b/src/errors.h
index b021f8204..91308fcfd 100644
--- a/src/errors.h
+++ b/src/errors.h
@@ -3246,6 +3246,8 @@ EXTERN char e_cannot_use_s_colon_in_vim9_script_str[]
 	INIT(= N_("E1268: Cannot use s: in Vim9 script: %s"));
 EXTERN char e_cannot_create_vim9_script_variable_in_function_str[]
 	INIT(= N_("E1269: Cannot create a Vim9 script variable in a function: %s"));
+EXTERN char e_string_or_function_required_for_arrow_parens_expr[]
+	INIT(= N_("E1275: String or function required for ->(expr)"));
 #endif
 EXTERN char e_cannot_use_s_backslash_in_vim9_script[]
 	INIT(= N_("E1270: Cannot use :s\\/sub/ in Vim9 script"));
diff --git a/src/eval.c b/src/eval.c
index c4c403c19..f132db1d4 100644
--- a/src/eval.c
+++ b/src/eval.c
@@ -4002,19 +4002,23 @@ eval_lambda(
 	++*arg;
 	ret = eval1(arg, rettv, evalarg);
 	*arg = skipwhite_and_linebreak(*arg, evalarg);
-	if (**arg == ')')
+	if (**arg != ')')
 	{
-	    ++*arg;
+	    emsg(_(e_missing_closing_paren));
+	    return FAIL;
 	}
-	else
+	if (rettv->v_type != VAR_STRING && rettv->v_type != VAR_FUNC
+					       && rettv->v_type != VAR_PARTIAL)
 	{
-	    emsg(_(e_missing_closing_paren));
-	    ret = FAIL;
+	    emsg(_(e_string_or_function_required_for_arrow_parens_expr));
+	    return FAIL;
 	}
+	++*arg;
     }
     if (ret != OK)
 	return FAIL;
-    else if (**arg != '(')
+
+    if (**arg != '(')
     {
 	if (verbose)
 	{
diff --git a/src/testdir/test_lambda.vim b/src/testdir/test_lambda.vim
index e6dcb6774..8d06e5973 100644
--- a/src/testdir/test_lambda.vim
+++ b/src/testdir/test_lambda.vim
@@ -66,6 +66,10 @@ function Test_lambda_fails()
   echo assert_fails('echo 10->{a -> a + 2}', 'E107:')
 
   call assert_fails('eval 0->(', "E110: Missing ')'")
+  call assert_fails('eval 0->(3)()', "E1275:")
+  call assert_fails('eval 0->([3])()', "E1275:")
+  call assert_fails('eval 0->({"a": 3})()', "E1275:")
+  call assert_fails('eval 0->(xxx)()', "E121:")
 endfunc
 
 func Test_not_lamda()
diff --git a/src/version.c b/src/version.c
index 450d49bf1..95a94c4d5 100644
--- a/src/version.c
+++ b/src/version.c
@@ -750,6 +750,8 @@ static char *(features[]) =
 
 static int included_patches[] =
 {   /* Add new patch number below this line */
+/**/
+    4774,
 /**/
     4524,
 /**/

--
2.25.1
