Backport of:

From 036bc3ddcbb56f05c6ca76712a53b89dee1369e2 Mon Sep 17 00:00:00 2001
From: Christian Persch <chpe@src.gnome.org>
Date: Sun, 2 Jun 2024 19:19:35 +0200
Subject: [PATCH] emulation: Restrict resize request to sane numbers

Fixes: https://gitlab.gnome.org/GNOME/vte/-/issues/2786
(cherry picked from commit fd5511f24b7269195a7083f409244e9787c705dc)

Upstream-Status: Backport [import from ubuntu https://git.launchpad.net/ubuntu/+source/vte2.91/tree/debian/patches/CVE-2024-37535-1.patch?h=ubuntu/focal-security
Upstream commit https://gitlab.gnome.org/GNOME/vte/-/commit/036bc3ddcbb56f05c6ca76712a53b89dee1369e2]
CVE: CVE-2024-37535
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 src/vteseq.cc | 20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

--- a/src/vteseq.cc
+++ b/src/vteseq.cc
@@ -209,9 +209,18 @@ Terminal::emit_bell()
 /* Emit a "resize-window" signal.  (Grid size.) */
 void
 Terminal::emit_resize_window(guint columns,
-                                       guint rows)
+                             guint rows)
 {
-        _vte_debug_print(VTE_DEBUG_SIGNALS, "Emitting `resize-window'.\n");
+        // Ignore resizes with excessive number of rows or columns,
+        // see https://gitlab.gnome.org/GNOME/vte/-/issues/2786
+        if (columns < 2 ||
+            columns > 511 ||
+            rows < 1 ||
+            rows > 511)
+                return;
+
+        _vte_debug_print(VTE_DEBUG_SIGNALS, "Emitting `resize-window' %d columns %d rows.\n",
+                         columns, rows);
         g_signal_emit(m_terminal, signals[SIGNAL_RESIZE_WINDOW], 0, columns, rows);
 }
 
@@ -4401,8 +4410,6 @@ Terminal::DECSLPP(vte::parser::Sequence
         else if (param < 24)
                 return;
 
-        _vte_debug_print(VTE_DEBUG_EMULATION, "Resizing to %d rows.\n", param);
-
         emit_resize_window(m_column_count, param);
 }
 
@@ -8610,9 +8617,6 @@ Terminal::XTERM_WM(vte::parser::Sequence
                 seq.collect(1, {&height, &width});
 
                 if (width != -1 && height != -1) {
-                        _vte_debug_print(VTE_DEBUG_EMULATION,
-                                         "Resizing window to %d columns, %d rows.\n",
-                                         width, height);
                         emit_resize_window(width, height);
                 }
                 break;
