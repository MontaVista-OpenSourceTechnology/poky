From 3e5c26415811f19e7737238bb23305ffaf96f66b Mon Sep 17 00:00:00 2001
From: Patrick Griffis <pgriffis@igalia.com>
Date: Wed, 5 Feb 2025 16:18:10 -0600
Subject: [PATCH] session: Strip authentication credentails on cross-origin
 redirect

This should match the behavior of Firefox and Safari but not of Chromium.
---
 libsoup/soup-session.c |  6 ++++
 tests/auth-test.c      | 77 ++++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 83 insertions(+)

This fixes CVE-2025-46421.

Signed-off-by: Javier Campos <jcampos@mvista.com>

Index: libsoup-2.58.2/libsoup/soup-session.c
===================================================================
--- libsoup-2.58.2.orig/libsoup/soup-session.c
+++ libsoup-2.58.2/libsoup/soup-session.c
@@ -1174,6 +1174,12 @@ soup_session_redirect_message (SoupSessi
 						   SOUP_ENCODING_NONE);
 	}
 
+	/* Strip all credentials on cross-origin redirect. */
+	if (!soup_uri_host_equal (soup_message_get_uri (msg), new_uri)) {
+		soup_message_headers_remove (msg->request_headers, "Authorization");
+		soup_message_set_auth (msg, NULL);
+	}
+
 	soup_message_set_uri (msg, new_uri);
 	soup_uri_free (new_uri);
 
