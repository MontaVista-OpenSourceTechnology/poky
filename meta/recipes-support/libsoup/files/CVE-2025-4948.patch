From: Milan Crha <mcrha@redhat.com> 
Date: Thu, 15 May 2025 17:49:11 +0200 
Subject: [PATCH] soup-multipart: Verify boundary limits for multipart body

It could happen that the boundary started at a place which resulted into
a negative number, which in an unsigned integer is a very large value.
Check the body size is not a negative value before setting it.

Closes https://gitlab.gnome.org/GNOME/libsoup/-/issues/449

Upstream-Status: Backport [import from https://gitlab.gnome.org/GNOME/libsoup/-/commit/66521f00e9f87f709d8ad9138f19052db933cf06]
CVE: CVE-2025-4948
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>
---
 libsoup/soup-multipart.c |  2 +-
 tests/multipart-test.c   | 52 ++++++++++++++++++++++++++++++++++++++++
 2 files changed, 53 insertions(+), 1 deletion(-)

diff --git a/libsoup/soup-multipart.c b/libsoup/soup-multipart.c
index dd93973..ce2fc10 100644
--- a/libsoup/soup-multipart.c
+++ b/libsoup/soup-multipart.c
@@ -214,7 +214,7 @@ soup_multipart_new_from_message (SoupMessageHeaders *headers,
 		 */
 		part_body = soup_buffer_new_subbuffer (flattened,
 						       split - flattened->data,
-						       end - 2 - split);
+						       end - 2 >= split ? end - 2 - split : 0);
 		g_ptr_array_add (multipart->bodies, part_body);
 
 		start = end;
diff --git a/tests/multipart-test.c b/tests/multipart-test.c
index 422d6c1..b567445 100644
--- a/tests/multipart-test.c
+++ b/tests/multipart-test.c
@@ -562,6 +562,57 @@ test_multipart_bounds_bad (void)
 	g_bytes_unref (bytes);
 }
 
+static void
+test_multipart_too_large (void)
+{
+	const char *raw_body =
+		"-------------------\r\n"
+		"-\n"
+		"Cont\"\r\n"
+		"Content-Tynt----e:n\x8erQK\r\n"
+		"Content-Disposition:   name=  form-; name=\"file\"; filename=\"ype:i/  -d; ----\xae\r\n"
+		"Content-Typimag\x01/png--\\\n"
+		"\r\n"
+		"---:\n\r\n"
+		"\r\n"
+		"-------------------------------------\r\n"
+		"---------\r\n"
+		"----------------------";
+	GBytes *gbytes;
+	GHashTable *params;
+	SoupMessageHeaders *headers;
+	SoupMultipart *multipart;
+	SoupMessageBody *body;
+	SoupBuffer *part_buffer = NULL;
+	SoupMessageHeaders *part_headers = NULL;
+
+	params = g_hash_table_new (g_str_hash, g_str_equal);
+	g_hash_table_insert (params, (gpointer) "boundary", (gpointer) "-----------------");
+	headers = soup_message_headers_new (SOUP_MESSAGE_HEADERS_MULTIPART);
+	soup_message_headers_set_content_type (headers, "multipart/form-data", params);
+	g_hash_table_unref (params);
+
+	/* Create SoupMessageBody from raw_body */
+	gbytes = g_bytes_new_static (raw_body, strlen (raw_body));
+	body = soup_message_body_new ();
+	soup_message_body_append (body, SOUP_MEMORY_STATIC, g_bytes_get_data (gbytes, NULL), g_bytes_get_size (gbytes));
+
+	multipart = soup_multipart_new_from_message (headers, body);
+
+	soup_message_headers_free (headers);
+	soup_message_body_free (body);
+	g_bytes_unref (gbytes);
+
+	g_assert_nonnull (multipart);
+	g_assert_cmpint (soup_multipart_get_length (multipart), ==, 1);
+	g_assert_true (soup_multipart_get_part (multipart, 0, &part_headers, &part_buffer));
+	g_assert_cmpint (part_buffer->length, ==, 0);
+
+	soup_multipart_free (multipart);
+	soup_message_headers_free (part_headers);
+	soup_buffer_free (part_buffer);
+}
+
 int
 main (int argc, char **argv)
 {
@@ -593,6 +644,7 @@ main (int argc, char **argv)
 	g_test_add_data_func ("/multipart/async-small-reads", GINT_TO_POINTER (ASYNC_MULTIPART_SMALL_READS), test_multipart);
 	g_test_add_func ("/multipart/bounds-good", test_multipart_bounds_good);
 	g_test_add_func ("/multipart/bounds-bad", test_multipart_bounds_bad);
+	g_test_add_func ("/multipart/too-large", test_multipart_too_large);
 
 	ret = g_test_run ();
 
-- 
2.24.4

