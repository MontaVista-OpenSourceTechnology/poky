From 473851777cd8596d63f0d6fc2f1280b8bae93692 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Tue, 15 Nov 2022 09:31:10 +0000
Subject: [PATCH] Allow fuzz builds to detect string overruns

If FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION is defined then we don't NUL
terminate ASN1_STRING datatypes. This shouldn't be necessary but we add it
any for safety in normal builds.

Upstream-Status: Backport [https://debian.sipwise.com/debian-security/pool/main/o/openssl1.0/openssl1.0_1.0.2u-1~deb9u6.debian.tar.xz]
CVE: CVE-2021-3712
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 crypto/asn1/asn1_lib.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/crypto/asn1/asn1_lib.c b/crypto/asn1/asn1_lib.c
index b52c3e1..4bed75b 100644
--- a/crypto/asn1/asn1_lib.c
+++ b/crypto/asn1/asn1_lib.c
@@ -387,7 +387,16 @@ int ASN1_STRING_set(ASN1_STRING *str, const void *_data, int len)
     if (data != NULL) {
         memcpy(str->data, data, len);
         /* an allowance for strings :-) */
+#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION
+        /*
+         * Arbitrary byte on the end, which should never be read if the string
+         * length is being properly respected.
+         */
+        str->data[len] = 'x';
+#else
+        /* This should not be necessary - but we add it as a safety precaution */
         str->data[len] = '\0';
+#endif
     }
     return (1);
 }
-- 
2.18.2

