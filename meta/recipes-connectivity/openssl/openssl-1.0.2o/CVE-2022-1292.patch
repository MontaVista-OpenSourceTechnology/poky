From 1373b7403035c5c80268b86e95a09cd0b9365cbd Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 9 Jun 2022 10:05:23 +0530
Subject: [PATCH] CVE-2022-1292

Upstream-Status: Backport [https://git.openssl.org/gitweb/?p=openssl.git;a=commit;h=e5fd1728ef4c7a5bf7c7a7163ca60370460a6e23]
CVE: CVE-2022-0778

Except on VMS where it is safe.

Reviewed-by: Matthias St. Pierre <Matthias.St.Pierre@ncp-e.com>
Reviewed-by: Matt Caswell <matt@openssl.org>
Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 tools/c_rehash.in | 31 +++++++++++++++++++++++++------
 1 file changed, 25 insertions(+), 6 deletions(-)

diff --git a/tools/c_rehash.in b/tools/c_rehash.in
index 92cb503..09e1ee1 100644
--- a/tools/c_rehash.in
+++ b/tools/c_rehash.in
@@ -134,6 +134,23 @@ sub check_file {
 	return ($is_cert, $is_crl);
 }
 
+sub compute_hash {
+    my $fh;
+    if ( $^O eq "VMS" ) {
+        # VMS uses the open through shell
+        # The file names are safe there and list form is unsupported
+        if (!open($fh, "-|", join(' ', @_))) {
+            print STDERR "Cannot compute hash on '$fname'\n";
+            return;
+        }
+    } else {
+        if (!open($fh, "-|", @_)) {
+            print STDERR "Cannot compute hash on '$fname'\n";
+            return;
+        }
+    }
+    return (<$fh>, <$fh>);
+}
 
 # Link a certificate to its subject name hash value, each hash is of
 # the form <hash>.<n> where n is an integer. If the hash value already exists
@@ -143,11 +160,12 @@ sub check_file {
 
 sub link_hash_cert {
 		my $fname = $_[0];
-		my $x509hash = $_[1] || '-subject_hash';
-		$fname =~ s/'/'\\''/g;
-		my ($hash, $fprint) = `"$openssl" x509 $x509hash -fingerprint -noout -in "$fname"`;
+		my ($hash, $fprint) = compute_hash($openssl, "x509", $x509hash,
+                                                  "-fingerprint", "-noout",
+                                                  "-in", $fname);
 		chomp $hash;
 		chomp $fprint;
+		return if !$hash;
 		$fprint =~ s/^.*=//;
 		$fprint =~ tr/://d;
 		my $suffix = 0;
@@ -188,11 +206,12 @@ sub link_hash_crl_old {
 
 sub link_hash_crl {
 		my $fname = $_[0];
-		my $crlhash = $_[1] || "-hash";
-		$fname =~ s/'/'\\''/g;
-		my ($hash, $fprint) = `"$openssl" crl $crlhash -fingerprint -noout -in '$fname'`;
+		my ($hash, $fprint) = compute_hash($openssl, "crl", $crlhash,
+                                                  "-fingerprint", "-noout",
+                                                  "-in", $fname);
 		chomp $hash;
 		chomp $fprint;
+		return if !$hash;
 		$fprint =~ s/^.*=//;
 		$fprint =~ tr/://d;
 		my $suffix = 0;
-- 
2.25.1

