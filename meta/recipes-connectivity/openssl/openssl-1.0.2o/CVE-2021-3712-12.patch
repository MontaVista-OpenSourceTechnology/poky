From d244a4ddd2e5fea6fb4efc85552b3416581be0a7 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Thu, 17 Nov 2022 03:22:58 +0000
Subject: [PATCH] fixup! Fix the name constraints code to not assume NUL terminated strings

Upstream-Status: Backport [https://debian.sipwise.com/debian-security/pool/main/o/openssl1.0/openssl1.0_1.0.2u-1~deb9u6.debian.tar.xz]
CVE: CVE-2021-3712
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 crypto/x509v3/v3_ncons.c | 36 +++++++++++-------------------------
 1 file changed, 11 insertions(+), 25 deletions(-)

diff --git a/crypto/x509v3/v3_ncons.c b/crypto/x509v3/v3_ncons.c
index 3c884d7..38032e1 100644
--- a/crypto/x509v3/v3_ncons.c
+++ b/crypto/x509v3/v3_ncons.c
@@ -111,28 +111,13 @@ IMPLEMENT_ASN1_ALLOC_FUNCTIONS(NAME_CONSTRAINTS)
 #define IA5_OFFSET_LEN(ia5base, offset) \
     ((ia5base)->length - ((unsigned char *)(offset) - (ia5base)->data))
 
-/* Like strchr but for ASN1_IA5STRING. Additionally you can specify the
+/* Like memchr but for ASN1_IA5STRING. Additionally you can specify the
  * starting point to search from
  */
-static char *ia5strchr(ASN1_IA5STRING *str, const char *start, int c)
-{
-    int i;
-    int offset = (int)(start - (char *)str->data);
-
-    /* Should not happen */
-    if (offset > str->length || offset < 0)
-        return NULL;
-
-    for (i = offset; i < str->length && str->data[i] != c; i++);
-
-    if (i == str->length)
-        return NULL;
-
-    return (char *)&str->data[i];
-}
+# define ia5memchr(str, start, c) memchr(start, c, IA5_OFFSET_LEN(str, start))
 
-/* Like strrchr but for ASN1_IA5STRING */
-static char *ia5strrchr(ASN1_IA5STRING *str, int c)
+/* Like memrrchr but for ASN1_IA5STRING */
+static char *ia5memrchr(ASN1_IA5STRING *str, int c)
 {
     int i;
 
@@ -145,7 +130,8 @@ static char *ia5strrchr(ASN1_IA5STRING *str, int c)
 }
 
 /*
- * We cannot use strncasecmp here because that applies locale specific rules.
+ * We cannot use strncasecmp here because that applies locale specific rules. It
+ * also doesn't work with ASN1_STRINGs that may have embedded NUL characters.
  * For example in Turkish 'I' is not the uppercase character for 'i'. We need to
  * do a simple ASCII case comparison ignoring the locale (that is why we use
  * numeric constants below).
@@ -469,8 +455,8 @@ static int nc_email(ASN1_IA5STRING *eml, ASN1_IA5STRING *base)
 {
     const char *baseptr = (char *)base->data;
     const char *emlptr = (char *)eml->data;
-    const char *baseat = ia5strrchr(base, '@');
-    const char *emlat = ia5strrchr(eml, '@');
+    const char *baseat = ia5memrchr(base, '@');
+    const char *emlat = ia5memrchr(eml, '@');
     size_t basehostlen, emlhostlen;
 
     if (!emlat)
@@ -513,7 +499,7 @@ static int nc_uri(ASN1_IA5STRING *uri, ASN1_IA5STRING *base)
 {
     const char *baseptr = (char *)base->data;
     const char *hostptr = (char *)uri->data;
-    const char *p = ia5strchr(uri, (char *)uri->data, ':');
+    const char *p = ia5memchr(uri, (char *)uri->data, ':');
     int hostlen;
 
     /* Check for foo:// and skip past it */
@@ -528,10 +514,10 @@ static int nc_uri(ASN1_IA5STRING *uri, ASN1_IA5STRING *base)
 
     /* Look for a port indicator as end of hostname first */
 
-    p = ia5strchr(uri, hostptr, ':');
+    p = ia5memchr(uri, hostptr, ':');
     /* Otherwise look for trailing slash */
     if (p == NULL)
-        p = ia5strchr(uri, hostptr, '/');
+        p = ia5memchr(uri, hostptr, '/');
 
     if (p == NULL)
         hostlen = IA5_OFFSET_LEN(uri, hostptr);
-- 
2.18.2

