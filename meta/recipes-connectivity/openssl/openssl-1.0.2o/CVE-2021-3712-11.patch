From 53a952798f682c6b70c71ccbff527fbd3750e278 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Thu, 17 Nov 2022 02:29:43 +0000
Subject: [PATCH] fixup! Fix i2v_GENERAL_NAME to not assume NUL terminated strings

Upstream-Status: Backport [https://debian.sipwise.com/debian-security/pool/main/o/openssl1.0/openssl1.0_1.0.2u-1~deb9u6.debian.tar.xz]
CVE: CVE-2021-3712
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 crypto/x509v3/v3_utl.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/crypto/x509v3/v3_utl.c b/crypto/x509v3/v3_utl.c
index e73e662..37cf963 100644
--- a/crypto/x509v3/v3_utl.c
+++ b/crypto/x509v3/v3_utl.c
@@ -87,9 +87,12 @@ static int x509v3_add_len_value(const char *name, const char *value,
     char *tname = NULL, *tvalue = NULL;
     if (name != NULL && !(tname = BUF_strdup(name)))
         goto err;
-    if (value != NULL) {
-        /* We don't allow embeded NUL characters */
-        if (memchr(value, 0, vallen) != NULL)
+    if (value != NULL && vallen > 0) {
+        /*
+         * We tolerate a single trailing NUL character, but otherwise no
+         * embedded NULs
+         */
+        if (memchr(value, 0, vallen - 1) != NULL)
             goto err;
         tvalue = BUF_strndup(value, vallen);
         if (tvalue == NULL)
-- 
2.18.2

