From 841c34f49419d53624d88f4533fab63fee7c83c8 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Tue, 27 Sep 2022 11:11:52 +0000
Subject: [PATCH] avdtp: Fix parsing capabilities

This patch fixes size comparison and variable misassignment.

Reviewed-by: Alain Michaud <alainm@chromium.org>
Reviewed-by: Michael Sun <michaelfsun@google.com>

Upstream-Status: Backport from https://git.kernel.org/pub/scm/bluetooth/bluez.git/commit/?id=0388794dc5fdb73a4ea88bcf148de0a12b4364d4
CVE: CVE-2022-39177
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 profiles/audio/avdtp.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/profiles/audio/avdtp.c b/profiles/audio/avdtp.c
index abb0d73..358c833 100644
--- a/profiles/audio/avdtp.c
+++ b/profiles/audio/avdtp.c
@@ -1267,7 +1267,7 @@ static GSList *caps_to_list(uint8_t *data, size_t size,
 
                 cap = (struct avdtp_service_capability *)data;
 
-                if (sizeof(*cap) + cap->length >= size) {
+                if (sizeof(*cap) + cap->length > size) {
 			error("Invalid capability data in getcap resp");
 			break;
 		}
@@ -1289,7 +1289,7 @@ static GSList *caps_to_list(uint8_t *data, size_t size,
                 switch (cap->category) {
                 case AVDTP_MEDIA_CODEC:
                         if (codec)
-                                *codec = cap;
+                                *codec = cpy;
                         break;
                 case AVDTP_DELAY_REPORTING:
                         if (delay_reporting)
-- 
2.18.2

