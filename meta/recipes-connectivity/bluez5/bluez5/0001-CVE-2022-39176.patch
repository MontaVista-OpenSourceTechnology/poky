From 8e8c9f2aa29ce0adccf3a5ef9c3e471e4e8d3eac Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Tue, 27 Sep 2022 10:43:49 +0000
Subject: [PATCH] avrcp: Fix not checking if params_len match number of received bytes

This makes sure the number of bytes in the params_len matches the
remaining bytes received so the code don't end up accessing invalid
memory.

Upstream-Status: Backport from https://git.kernel.org/pub/scm/bluetooth/bluez.git/commit/?id=e2b0f0d8d63e1223bb714a9efb37e2257818268b
CVE: CVE-2022-39176
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 profiles/audio/avrcp.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/profiles/audio/avrcp.c b/profiles/audio/avrcp.c
index 2c1434d..5bc132c 100644
--- a/profiles/audio/avrcp.c
+++ b/profiles/audio/avrcp.c
@@ -1843,6 +1843,14 @@ static size_t handle_vendordep_pdu(struct avctp *conn, uint8_t transaction,
 		goto err_metadata;
 	}
 
+        operands += sizeof(*pdu);
+        operand_count -= sizeof(*pdu);
+
+        if (pdu->params_len != operand_count) {
+                DBG("AVRCP PDU parameters length don't match");
+                pdu->params_len = operand_count;
+        }
+
 	for (handler = session->control_handlers; handler->pdu_id; handler++) {
 		if (handler->pdu_id == pdu->pdu_id)
 			break;
-- 
2.18.2

