From f96f3e4fa693468493fc9d2d8b511f85fd9eccb9 Mon Sep 17 00:00:00 2001
From: "djm@openbsd.org" <djm@openbsd.org>
Date: Wed, 9 Apr 2025 07:00:03 +0000
Subject: [PATCH] upstream: Fix logic error in DisableForwarding option. This
 option

was documented as disabling X11 and agent forwarding but it failed to do so.
Spotted by Tim Rice.

OpenBSD-Commit-ID: fffc89195968f7eedd2fc57f0b1f1ef3193f5ed1

Upstream-Status: Backport from [https://github.com/openssh/openssh-portable/commit/fc86875e6acb36401dfc1dfb6b628a9d1460f367]
CVE: CVE-2025-32728
Signed-off-by: Siddharth Doshi <sdoshi@mvista.com>
---
 session.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/session.c b/session.c
index a08aa69..af6555b 100644
--- a/session.c
+++ b/session.c
@@ -2056,7 +2056,8 @@ session_auth_agent_req(Session *s)
 {
 	static int called = 0;
 	packet_check_eom();
-	if (no_agent_forwarding_flag || !options.allow_agent_forwarding) {
+	if (no_agent_forwarding_flag || !options.allow_agent_forwarding ||
+	    options.disable_forwarding) {
 		debug("session_auth_agent_req: no_agent_forwarding_flag");
 		return 0;
 	}
@@ -2443,7 +2444,7 @@ session_setup_x11fwd(Session *s)
 		packet_send_debug("X11 forwarding disabled in user configuration file.");
 		return 0;
 	}
-	if (!options.x11_forwarding) {
+	if (!options.x11_forwarding || options.disable_forwarding) {
 		debug("X11 forwarding disabled in server configuration file.");
 		return 0;
 	}
-- 
2.18.2

