From 41ab0709d1bde6fb8a2dde623d00e69bc48fab0d Mon Sep 17 00:00:00 2001
From: Evan Hunt <each@isc.org>
Date: Mon, 29 Sep 2025 22:17:39 -0700
Subject: [PATCH 1/3] Tighten restrictions on caching NS RRsets in authority
 section

To prevent certain spoofing attacks, a new check has been added
to the existing rules for whether NS data can be cached: the owner
name of the NS RRset must be an ancestor of the name being queried.

(cherry picked from commit fa153f791f9324bf84abf8d259e11c0531fe6e25)

Upstream-Status: Backport from [https://gitlab.com/isc-projects/bind9/-/commit/41ab0709d1bde6fb8a2dde623d00e69bc48fab0d]
CVE: CVE-2025-40778 
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>

---
 lib/dns/resolver.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/lib/dns/resolver.c b/lib/dns/resolver.c
index eab855e..e3dae27 100644
--- a/lib/dns/resolver.c
+++ b/lib/dns/resolver.c
@@ -7511,7 +7511,9 @@ answer_response(fetchctx_t *fctx, dns_message_t *message) {
 	while (!done && result == ISC_R_SUCCESS) {
 		name = NULL;
 		dns_message_currentname(message, DNS_SECTION_AUTHORITY, &name);
-		if (!name_external(name, dns_rdatatype_ns, fctx)) {
+		if (!name_external(name, dns_rdatatype_ns, fctx) &&
+		    dns_name_issubdomain(&fctx->name, name))
+		{
 			/*
 			 * We expect to find NS or SIG NS rdatasets, and
 			 * nothing else.
-- 
2.34.1

