From c08452439cb08b82b595d33aca04f7d59126be1b Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 9 Nov 2021 11:52:20 +0530
Subject: [PATCH] CVE-2021-25215

[security]	named crashed when a DNAME record placed in the ANSWER
		section during DNAME chasing turned out to be the final
		answer to a client query. (CVE-2021-25215) [GL #2540]

Upstream-Status: Backport from 122de2529968533462d36324eb16080a5337b795

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 bin/named/query.c | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/bin/named/query.c b/bin/named/query.c
index 3bae106..261f4cc 100644
--- a/bin/named/query.c
+++ b/bin/named/query.c
@@ -8296,10 +8296,17 @@ query_find(ns_client_t *client, dns_fetchevent_t *event, dns_rdatatype_t qtype)
 		if (noqname != NULL)
 			query_addnoqnameproof(client, noqname);
 		/*
-		 * We shouldn't ever fail to add 'rdataset'
-		 * because it's already in the answer.
+		 * 'rdataset' will only be non-NULL here if the ANSWER section
+		 * of the message to be sent to the client already contains an
+		 * RRset with the same owner name and the same type as
+		 * 'rdataset'.  This should never happen, with one exception:
+		 * when chasing DNAME records, one of the DNAME records placed
+		 * in the ANSWER section may turn out to be the final answer to
+		 * the client's query, but we have no way of knowing that until
+		 * now.  In such a case, 'rdataset' will be freed later, so we
+		 * do not need to free it here.
 		 */
-		INSIST(rdataset == NULL);
+		INSIST(rdataset == NULL || qtype == dns_rdatatype_dname);
 	}
 
  addauth:
-- 
2.25.1

