From bc2fb30704e347f6ade946d7e462d231f7dc0ff4 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 3 Aug 2022 05:18:43 +0000
Subject: [PATCH] CVE-2021-25214_2

Address inconsistencies in checking added RRsets

loading_addrdataset() rejects SOA RRsets which are not at top of zone.
addrdataset() should similarly reject such RRsets.

Upstream-Status: Backport from https://gitlab.isc.org/isc-projects/bind9/-/commit/f092fcee10a7e8b391747dbdd7e58243bff4f75c
CVE: CVE-2021-25214
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/dns/rbtdb.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/lib/dns/rbtdb.c b/lib/dns/rbtdb.c
index e6658e4..467185b 100644
--- a/lib/dns/rbtdb.c
+++ b/lib/dns/rbtdb.c
@@ -6620,13 +6620,21 @@ addrdataset(dns_db_t *db, dns_dbnode_t *node, dns_dbversion_t *version,
 	REQUIRE(VALID_RBTDB(rbtdb));
 	INSIST(rbtversion == NULL || rbtversion->rbtdb == rbtdb);
 
-	if (rbtdb->common.methods == &zone_methods)
+	if (rbtdb->common.methods == &zone_methods) {
+                /*
+                 * SOA records are only allowed at top of zone.
+                 */
+                if (rdataset->type == dns_rdatatype_soa &&
+                    node != rbtdb->origin_node) {
+                        return (DNS_R_NOTZONETOP);
+                }
 		REQUIRE(((rbtnode->nsec == DNS_RBT_NSEC_NSEC3 &&
 			  (rdataset->type == dns_rdatatype_nsec3 ||
 			   rdataset->covers == dns_rdatatype_nsec3)) ||
 			 (rbtnode->nsec != DNS_RBT_NSEC_NSEC3 &&
 			   rdataset->type != dns_rdatatype_nsec3 &&
 			   rdataset->covers != dns_rdatatype_nsec3)));
+        }
 
 	if (rbtversion == NULL) {
 		if (now == 0)
-- 
2.18.2

