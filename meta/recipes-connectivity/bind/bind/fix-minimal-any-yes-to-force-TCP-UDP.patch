From 706c6ac5e232735060f95e3bbd64a9acd85d2f84 Mon Sep 17 00:00:00 2001
From: Mark Andrews <marka@isc.org>
Date: Thu, 20 Apr 2017 17:59:45 +1000
Subject: [PATCH] fix 'minimal-any yes;' to force TCP / UDP

---
 bin/tests/system/additional/tests.sh | 22 ++++++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

This fixes CVE-2024-11187. Dependency Patch #4.

Signed-off-by: Javier Campos <jcampos@mvista.com>

Index: bind-9.10.5-P3/bin/tests/system/additional/tests.sh
===================================================================
--- bind-9.10.5-P3.orig/bin/tests/system/additional/tests.sh
+++ bind-9.10.5-P3/bin/tests/system/additional/tests.sh
@@ -133,9 +133,27 @@ $RNDC -c ../common/rndc.conf -s 10.53.0.
 sleep 2
 
 n=`expr $n + 1`
-echo "I:testing with 'minimal-any yes;' ($n)"
+echo "I:testing with 'minimal-any yes;' over UDP ($n)"
 ret=0
-$DIG -t ANY www.rt.example @10.53.0.1 -p 5300 > dig.out.$n || ret=1
+$DIG -t ANY +notcp www.rt.example @10.53.0.1 -p 5300 > dig.out.$n || ret=1
+grep "ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1" dig.out.$n > /dev/null || ret=1
+if [ $ret -eq 1 ] ; then
+    echo "I: failed"; status=1
+fi
+n=`expr $n + 1`
+
+echo "I:testing with 'minimal-any yes;' over TCP ($n)"
+ret=0
+$DIG -t ANY +tcp www.rt.example @10.53.0.1 -p 5300 > dig.out.$n || ret=1
+grep "ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1" dig.out.$n > /dev/null || ret=1
+if [ $ret -eq 1 ] ; then
+    echo "I: failed"; status=1
+fi
+
+n=`expr $n + 1`
+echo "I:testing with 'minimal-any yes;' over UDP ($n)"
+ret=0
+$DIG -t ANY +notcp www.rt.example @10.53.0.1 -p 5300 > dig.out.$n || ret=1
 grep "ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1" dig.out.$n > /dev/null || ret=1
 if [ $ret -eq 1 ] ; then
     echo "I: failed"; status=1
