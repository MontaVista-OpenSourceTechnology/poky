From 4e0637a9ad350cb5bbc7d0060c59aa17ebd8eaa1 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 3 Aug 2022 04:58:21 +0000
Subject: [PATCH] CVE-2021-25214_1

Check SOA owner names in zone transfers

An IXFR containing SOA records with owner names different than the
transferred zone's origin can result in named serving a version of that
zone without an SOA record at the apex.  This causes a RUNTIME_CHECK
assertion failure the next time such a zone is refreshed.  Fix by
immediately rejecting a zone transfer (either an incremental or
non-incremental one) upon detecting an SOA record not placed at the apex
of the transferred zone.

Upstream-Status: Backport from https://gitlab.isc.org/isc-projects/bind9/-/commit/f68d4cba3321ed375bbc334e2333250893c4f587
CVE: CVE-2021-25214
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/dns/xfrin.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/lib/dns/xfrin.c b/lib/dns/xfrin.c
index 1d47486..c868195 100644
--- a/lib/dns/xfrin.c
+++ b/lib/dns/xfrin.c
@@ -478,6 +478,20 @@ xfr_rr(dns_xfrin_ctx_t *xfr, dns_name_t *name, isc_uint32_t ttl,
 	    dns_rdatatype_ismeta(rdata->type))
 		FAIL(DNS_R_FORMERR);
 
+        /*
+         * Immediately reject the entire transfer if the RR that is currently
+         * being processed is an SOA record that is not placed at the zone
+         * apex.
+         */
+        if (rdata->type == dns_rdatatype_soa &&
+            !dns_name_equal(&xfr->name, name)) {
+                char namebuf[DNS_NAME_FORMATSIZE];
+                dns_name_format(name, namebuf, sizeof(namebuf));
+                xfrin_log(xfr, ISC_LOG_DEBUG(3), "SOA name mismatch: '%s'",
+                          namebuf);
+                FAIL(DNS_R_NOTZONETOP);
+        }
+
  redo:
 	switch (xfr->state) {
 	case XFRST_SOAQUERY:
-- 
2.18.2

