From f1b91aa7880901277bc750c55edd8a1f4cdc3f1a Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Mon, 12 Sep 2022 12:42:06 +0000
Subject: [PATCH] CVE-2018-5745_p1


Don't free key in compute_tag in case of failure

If `dns_dnssec_keyfromrdata` failed we don't need to call
`dst_key_free` because no `dstkey` was created.  Doing so
nevertheless will result in an assertion failure.

This can happen if the key uses an unsupported algorithm.

Upstream-Status: Backport from https://gitlab.isc.org/isc-projects/bind9/-/commit/235a64a5a4c0143b183bd55f6ed756741d4d7880
CVE: CVE-2018-5745
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 lib/dns/zone.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/lib/dns/zone.c b/lib/dns/zone.c
index 383ad48..ca8bbc8 100644
--- a/lib/dns/zone.c
+++ b/lib/dns/zone.c
@@ -3635,9 +3635,10 @@ compute_tag(dns_name_t *name, dns_rdata_dnskey_t *dnskey, isc_mem_t *mctx,
 			     dns_rdatatype_dnskey, dnskey, &buffer);
 
 	result = dns_dnssec_keyfromrdata(name, &rdata, mctx, &dstkey);
-	if (result == ISC_R_SUCCESS)
+	if (result == ISC_R_SUCCESS) {
 		*tag = dst_key_id(dstkey);
-	dst_key_free(&dstkey);
+	        dst_key_free(&dstkey);
+        }
 
 	return (result);
 }
-- 
2.18.2

