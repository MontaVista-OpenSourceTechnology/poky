From 28b0977b07bf980c93e48c20c5de7fe32eff8b9f Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Mon, 26 Dec 2022 06:50:09 +0000
Subject: [PATCH] font: Reject glyphs exceeds font->max_glyph_width or font->max_glyph_height

Check glyph's width and height against limits specified in font's
metadata. Reject the glyph (and font) if such limits are exceeded.

Signed-off-by: Zhang Boyang <zhangboyang.id@gmail.com>
Reviewed-by: Daniel Kiper <daniel.kiper@oracle.com>

Upstream-Status: Backport [https://lists.gnu.org/archive/html/grub-devel/2022-11/msg00059.html]
CVE: CVE-2022-2601
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 grub-core/font/font.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/grub-core/font/font.c b/grub-core/font/font.c
index 5ae6ca9..83f804a 100644
--- a/grub-core/font/font.c
+++ b/grub-core/font/font.c
@@ -755,7 +755,9 @@ grub_font_get_glyph_internal (grub_font_t font, grub_uint32_t code)
 	  || read_be_uint16 (font->file, &height) != 0
 	  || read_be_int16 (font->file, &xoff) != 0
 	  || read_be_int16 (font->file, &yoff) != 0
-	  || read_be_int16 (font->file, &dwidth) != 0)
+	  || read_be_int16 (font->file, &dwidth) != 0
+          || width > font->max_char_width
+          || height > font->max_char_height)
 	{
 	  remove_font (font);
 	  return 0;
-- 
2.18.2

