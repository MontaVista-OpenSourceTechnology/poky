From a76de69b62ea618ae60e853db7eddb966599a20d Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Mon, 19 Jan 2026 10:55:16 +0000
Subject: [PATCH] Fix segfault on some weird data structures

Upstream-Status: Backport [https://sourceforge.net/p/gptfdisk/code/ci/81c8bbee46ad6ebacf72eae70ba5147f376205a4]
CVE: CVE-2020-0256
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 gpt.cc | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/gpt.cc b/gpt.cc
index fe8e956..1b4e10f 100644
--- a/gpt.cc
+++ b/gpt.cc
@@ -1041,6 +1041,14 @@ int GPTData::LoadHeader(struct GPTHeader *header, DiskIO & disk, uint64_t sector
    } // if
    *crcOk = CheckHeaderCRC(&tempHeader);
 
+   if (tempHeader.sizeOfPartitionEntries != sizeof(GPTPart)) {
+       cerr << "Warning: Partition table header claims that the size of partition table\n";
+       cerr << "entries is " << tempHeader.sizeOfPartitionEntries << " bytes, but this program ";
+       cerr << " supports only " << sizeof(GPTPart) << "-byte entries.\n";
+       cerr << "Adjusting accordingly, but partition table may be garbage.\n";
+       tempHeader.sizeOfPartitionEntries = sizeof(GPTPart);
+   }
+
    if (allOK && (numParts != tempHeader.numParts) && *crcOk) {
       allOK = SetGPTSize(tempHeader.numParts, 0);
    }
@@ -1058,7 +1066,10 @@ int GPTData::LoadPartitionTable(const struct GPTHeader & header, DiskIO & disk,
    uint32_t sizeOfParts, newCRC;
    int retval;
 
-   if (disk.OpenForRead()) {
+   if (header.sizeOfPartitionEntries != sizeof(GPTPart)) {
+      cerr << "Error! GPT header contains invalid partition entry size!\n";
+      retval = 0;
+   } else if (disk.OpenForRead()) {
       if (sector == 0) {
          retval = disk.Seek(header.partitionEntriesLBA);
       } else {
-- 
2.24.4

