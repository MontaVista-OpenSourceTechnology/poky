From a09ccc22459c565814f79f96586fe4ad083fe4eb Mon Sep 17 00:00:00 2001
From: Martin Jambor <mjambor@suse.cz>
Date: Sat, 21 Dec 2019 12:25:05 +0100
Subject: [PATCH] Avoid segfault when doing IPA-VRP but not IPA-CP (PR 93015)

2019-12-21  Martin Jambor  <mjambor@suse.cz>

	PR ipa/93015
	* ipa-cp.c (ipcp_store_vr_results): Check that info exists

	testsuite/
	* gcc.dg/lto/pr93015_0.c: New test.

From-SVN: r279695

Upsteam-State: Backport
CVE: CVE-2020-35537
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 gcc/ChangeLog                        | 5 +++++
 gcc/ipa-cp.c                         | 2 +-
 gcc/testsuite/ChangeLog              | 5 +++++
 gcc/testsuite/gcc.dg/lto/pr93015_0.c | 6 ++++++
 4 files changed, 17 insertions(+), 1 deletion(-)
 create mode 100644 gcc/testsuite/gcc.dg/lto/pr93015_0.c

Index: gcc-8.2.0/gcc/ipa-cp.c
===================================================================
--- gcc-8.2.0.orig/gcc/ipa-cp.c
+++ gcc-8.2.0/gcc/ipa-cp.c
@@ -5016,7 +5016,7 @@ ipcp_store_vr_results (void)
       ipa_node_params *info = IPA_NODE_REF (node);
       bool found_useful_result = false;
 
-      if (!opt_for_fn (node->decl, flag_ipa_vrp))
+      if (!info || !opt_for_fn (node->decl, flag_ipa_vrp))
 	{
 	  if (dump_file)
 	    fprintf (dump_file, "Not considering %s for VR discovery "
Index: gcc-8.2.0/gcc/testsuite/gcc.dg/lto/pr93015_0.c
===================================================================
--- /dev/null
+++ gcc-8.2.0/gcc/testsuite/gcc.dg/lto/pr93015_0.c
@@ -0,0 +1,6 @@
+/* { dg-lto-do link } */
+/* { dg-lto-options { { -O0 -fipa-vrp -flto } } } */
+
+int main() {
+
+}
Index: gcc-8.2.0/gcc/ChangeLog
===================================================================
--- gcc-8.2.0.orig/gcc/ChangeLog
+++ gcc-8.2.0/gcc/ChangeLog
@@ -1,3 +1,10 @@
+MontaVista Changes:
+2019-12-21  Martin Jambor  <mjambor@suse.cz>
+
+       PR ipa/93015
+       * ipa-cp.c (ipcp_store_vr_results): Check that info exists
+
+--------------------------
 2018-07-26  Release Manager
 
 	* GCC 8.2.0 released.
