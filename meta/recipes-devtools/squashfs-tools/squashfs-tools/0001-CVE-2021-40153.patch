From c413d565475a90cb427a5d396b0d7c70d90623b1 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Thu, 9 Dec 2021 11:40:24 +0530
Subject: [PATCH] CVE-2021-40153

Upstream-Status: Backport from https://security-tracker.debian.org/tracker/DLA-2752-1

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 Makefile        |  5 ++-
 unsquash-1.c    |  7 ++++
 unsquash-1234.c | 58 ++++++++++++++++++++++++++++++++++
 unsquash-3.c    |  7 ++++
 unsquash-4.c    |  7 ++++
 unsquashfs.h    |  4 +++
 6 files changed, 87 insertions(+), 1 deletion(-)
 create mode 100644 unsquash-1234.c

diff --git a/Makefile b/Makefile
index 52d2582..c00b186 100644
--- a/Makefile
+++ b/Makefile
@@ -115,7 +115,8 @@ MKSQUASHFS_OBJS = mksquashfs.o read_fs.o action.o swap.o pseudo.o compressor.o \
 	caches-queues-lists.o
 
 UNSQUASHFS_OBJS = unsquashfs.o unsquash-1.o unsquash-2.o unsquash-3.o \
-	unsquash-4.o swap.o compressor.o unsquashfs_info.o
+	unsquash-4.o unsquash-1234.o swap.o \
+	compressor.o unsquashfs_info.o
 
 CFLAGS ?= -O2
 CFLAGS += $(EXTRA_CFLAGS) $(INCLUDEDIR) -D_FILE_OFFSET_BITS=64 \
@@ -290,6 +291,8 @@ unsquash-3.o: unsquashfs.h unsquash-3.c squashfs_fs.h squashfs_compat.h
 unsquash-4.o: unsquashfs.h unsquash-4.c squashfs_fs.h squashfs_swap.h \
 	read_fs.h
 
+unsquash-1234.o: unsquash-1234.c
+
 unsquashfs_xattr.o: unsquashfs_xattr.c unsquashfs.h squashfs_fs.h xattr.h
 
 unsquashfs_info.o: unsquashfs.h squashfs_fs.h
diff --git a/unsquash-1.c b/unsquash-1.c
index c2e7d38..db4fd7e 100644
--- a/unsquash-1.c
+++ b/unsquash-1.c
@@ -285,6 +285,13 @@ struct dir *squashfs_opendir_1(unsigned int block_start, unsigned int offset,
 			memcpy(dire->name, directory_table + bytes,
 				dire->size + 1);
 			dire->name[dire->size + 1] = '\0';
+
+			/* check name for invalid characters (i.e /, ., ..) */
+			if(check_name(dire->name, dire->size + 1) == FALSE) {
+				ERROR("File system corrupted: invalid characters in name\n");
+				goto corrupted;
+			}
+
 			TRACE("squashfs_opendir: directory entry %s, inode "
 				"%d:%d, type %d\n", dire->name,
 				dirh.start_block, dire->offset, dire->type);
diff --git a/unsquash-1234.c b/unsquash-1234.c
new file mode 100644
index 0000000..c2d4f42
--- /dev/null
+++ b/unsquash-1234.c
@@ -0,0 +1,58 @@
+/*
+ * Unsquash a squashfs filesystem.  This is a highly compressed read only
+ * filesystem.
+ *
+ * Copyright (c) 2021
+ * Phillip Lougher <phillip@squashfs.org.uk>
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License
+ * as published by the Free Software Foundation; either version 2,
+ * or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, write to the Free Software
+ * Foundation, 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+ *
+ * unsquash-1234.c
+ *
+ * Helper functions used by unsquash-1, unsquash-2, unsquash-3 and
+ * unsquash-4.
+ */
+
+#define TRUE 1
+#define FALSE 0
+/*
+ * Check name for validity, name should not
+ *  - be ".", "./", or
+ *  - be "..", "../" or
+ *  - have a "/" anywhere in the name, or
+ *  - be shorter than the expected size
+ */
+int check_name(char *name, int size)
+{
+	char *start = name;
+
+	if(name[0] == '.') {
+		if(name[1] == '.')
+			name++;
+		if(name[1] == '/' || name[1] == '\0')
+			return FALSE;
+	}
+
+	while(name[0] != '/' && name[0] != '\0')
+		name ++;
+
+	if(name[0] == '/')
+		return FALSE;
+
+	if((name - start) != size)
+		return FALSE;
+
+	return TRUE;
+}
diff --git a/unsquash-3.c b/unsquash-3.c
index d5af57a..017743f 100644
--- a/unsquash-3.c
+++ b/unsquash-3.c
@@ -363,6 +363,13 @@ struct dir *squashfs_opendir_3(unsigned int block_start, unsigned int offset,
 			memcpy(dire->name, directory_table + bytes,
 				dire->size + 1);
 			dire->name[dire->size + 1] = '\0';
+
+			/* check name for invalid characters (i.e /, ., ..) */
+			if(check_name(dire->name, dire->size + 1) == FALSE) {
+				ERROR("File system corrupted: invalid characters in name\n");
+				goto corrupted;
+			}
+
 			TRACE("squashfs_opendir: directory entry %s, inode "
 				"%d:%d, type %d\n", dire->name,
 				dirh.start_block, dire->offset, dire->type);
diff --git a/unsquash-4.c b/unsquash-4.c
index ecdaac7..42c6652 100644
--- a/unsquash-4.c
+++ b/unsquash-4.c
@@ -321,6 +321,13 @@ struct dir *squashfs_opendir_4(unsigned int block_start, unsigned int offset,
 			memcpy(dire->name, directory_table + bytes,
 				dire->size + 1);
 			dire->name[dire->size + 1] = '\0';
+
+			/* check name for invalid characters (i.e /, ., ..) */
+			if(check_name(dire->name, dire->size + 1) == FALSE) {
+				ERROR("File system corrupted: invalid characters in name\n");
+				goto corrupted;
+			}
+
 			TRACE("squashfs_opendir: directory entry %s, inode "
 				"%d:%d, type %d\n", dire->name,
 				dirh.start_block, dire->offset, dire->type);
diff --git a/unsquashfs.h b/unsquashfs.h
index ecd0bb4..ac55a32 100644
--- a/unsquashfs.h
+++ b/unsquashfs.h
@@ -275,4 +275,8 @@ extern struct inode *read_inode_4(unsigned int, unsigned int);
 extern struct dir *squashfs_opendir_4(unsigned int, unsigned int,
 	struct inode **);
 extern int read_uids_guids_4();
+
+/* unsquash-1234.c */
+extern int check_name(char *, int);
+
 #endif
-- 
2.25.1

