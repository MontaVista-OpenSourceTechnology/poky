From 990bbeeff81320e83a981878f5ef3d4132e332c8 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 23 Nov 2022 11:18:38 +0000
Subject: [PATCH] unsquashfs: use squashfs_closedir() to delete directory

Upstream-Status: Backport [https://launchpad.net/ubuntu/+source/squashfs-tools/1:4.3-6ubuntu0.18.04.4]
CVE: CVE-2021-41072
Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 unsquash-1.c    |  3 +--
 unsquash-1234.c | 11 +++++++++--
 unsquash-3.c    |  3 +--
 unsquashfs.c    |  7 -------
 unsquashfs.h    |  1 +
 5 files changed, 12 insertions(+), 13 deletions(-)

diff --git a/unsquash-1.c b/unsquash-1.c
index db4fd7e..fbaebef 100644
--- a/unsquash-1.c
+++ b/unsquash-1.c
@@ -316,8 +316,7 @@ struct dir *squashfs_opendir_1(unsigned int block_start, unsigned int offset,
 	return dir;
 
 corrupted:
-	free(dir->dirs);
-	free(dir);
+        squashfs_closedir(dir);
 	return NULL;
 }
 
diff --git a/unsquash-1234.c b/unsquash-1234.c
index c2d4f42..15e9836 100644
--- a/unsquash-1234.c
+++ b/unsquash-1234.c
@@ -25,8 +25,8 @@
  * unsquash-4.
  */
 
-#define TRUE 1
-#define FALSE 0
+#include "unsquashfs.h"
+
 /*
  * Check name for validity, name should not
  *  - be ".", "./", or
@@ -56,3 +56,10 @@ int check_name(char *name, int size)
 
 	return TRUE;
 }
+
+
+void squashfs_closedir(struct dir *dir)
+{
+       free(dir->dirs);
+       free(dir);
+}
diff --git a/unsquash-3.c b/unsquash-3.c
index 017743f..695d24b 100644
--- a/unsquash-3.c
+++ b/unsquash-3.c
@@ -394,7 +394,6 @@ struct dir *squashfs_opendir_3(unsigned int block_start, unsigned int offset,
 	return dir;
 
 corrupted:
-	free(dir->dirs);
-	free(dir);
+        squashfs_closedir(dir);
 	return NULL;
 }
diff --git a/unsquashfs.c b/unsquashfs.c
index 63b5cec..26eb65b 100644
--- a/unsquashfs.c
+++ b/unsquashfs.c
@@ -1251,13 +1251,6 @@ unsigned int *offset, unsigned int *type)
 }
 
 
-void squashfs_closedir(struct dir *dir)
-{
-	free(dir->dirs);
-	free(dir);
-}
-
-
 char *get_component(char *target, char **targname)
 {
 	char *start;
diff --git a/unsquashfs.h b/unsquashfs.h
index ac55a32..62cc710 100644
--- a/unsquashfs.h
+++ b/unsquashfs.h
@@ -278,5 +278,6 @@ extern int read_uids_guids_4();
 
 /* unsquash-1234.c */
 extern int check_name(char *, int);
+extern void squashfs_closedir(struct dir *);
 
 #endif
-- 
2.18.2

