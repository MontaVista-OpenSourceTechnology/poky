From f6954307d7c28511b8204dad81a76138d8047887 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Thu, 24 Nov 2022 03:38:14 +0000
Subject: [PATCH] unsquashfs: dynamically allocate name

Dynamically allocate name rather than store it
directly in structure.

Signed-off-by: Phillip Lougher <phillip@squashfs.org.uk>

Upstream-Status: Backport [https://launchpad.net/ubuntu/+source/squashfs-tools/1:4.3-6ubuntu0.18.04.4]
CVE: CVE-2021-41072
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 unsquash-1.c    | 2 +-
 unsquash-1234.c | 5 +++++
 unsquash-3.c    | 2 +-
 unsquash-4.c    | 2 +-
 unsquashfs.h    | 2 +-
 5 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/unsquash-1.c b/unsquash-1.c
index fbaebef..784ee15 100644
--- a/unsquash-1.c
+++ b/unsquash-1.c
@@ -303,7 +303,7 @@ struct dir *squashfs_opendir_1(unsigned int block_start, unsigned int offset,
 						"realloc failed!\n");
 				dir->dirs = new_dir;
 			}
-			strcpy(dir->dirs[dir->dir_count].name, dire->name);
+                        dir->dirs[dir->dir_count].name = strdup(dire->name);
 			dir->dirs[dir->dir_count].start_block =
 				dirh.start_block;
 			dir->dirs[dir->dir_count].offset = dire->offset;
diff --git a/unsquash-1234.c b/unsquash-1234.c
index 15e9836..c5bc42a 100644
--- a/unsquash-1234.c
+++ b/unsquash-1234.c
@@ -60,6 +60,11 @@ int check_name(char *name, int size)
 
 void squashfs_closedir(struct dir *dir)
 {
+       int i;
+
+       for(i = 0; i < dir->dir_count; i++)
+               free(dir->dirs[i].name);
+
        free(dir->dirs);
        free(dir);
 }
diff --git a/unsquash-3.c b/unsquash-3.c
index 695d24b..b5aa712 100644
--- a/unsquash-3.c
+++ b/unsquash-3.c
@@ -381,7 +381,7 @@ struct dir *squashfs_opendir_3(unsigned int block_start, unsigned int offset,
 						"realloc failed!\n");
 				dir->dirs = new_dir;
 			}
-			strcpy(dir->dirs[dir->dir_count].name, dire->name);
+                        dir->dirs[dir->dir_count].name = strdup(dire->name);
 			dir->dirs[dir->dir_count].start_block =
 				dirh.start_block;
 			dir->dirs[dir->dir_count].offset = dire->offset;
diff --git a/unsquash-4.c b/unsquash-4.c
index 42c6652..43b639f 100644
--- a/unsquash-4.c
+++ b/unsquash-4.c
@@ -339,7 +339,7 @@ struct dir *squashfs_opendir_4(unsigned int block_start, unsigned int offset,
 						"realloc failed!\n");
 				dir->dirs = new_dir;
 			}
-			strcpy(dir->dirs[dir->dir_count].name, dire->name);
+                        dir->dirs[dir->dir_count].name = strdup(dire->name);
 			dir->dirs[dir->dir_count].start_block =
 				dirh.start_block;
 			dir->dirs[dir->dir_count].offset = dire->offset;
diff --git a/unsquashfs.h b/unsquashfs.h
index 62cc710..0457c71 100644
--- a/unsquashfs.h
+++ b/unsquashfs.h
@@ -168,7 +168,7 @@ struct queue {
 #define DIR_ENT_SIZE	16
 
 struct dir_ent	{
-	char		name[SQUASHFS_NAME_LEN + 1];
+        char            *name;
 	unsigned int	start_block;
 	unsigned int	offset;
 	unsigned int	type;
-- 
2.18.2

