From afed02e584bd159b468908342868e3d09f4be187 Mon Sep 17 00:00:00 2001
From: Vivek Kumbhar <vkumbhar@mvista.com>
Date: Mon, 22 Jul 2024 13:13:24 +0000
Subject: [PATCH] CVE-2022-48064

---
 bfd/dwarf2.c | 20 ++++++++++++--------
 1 file changed, 12 insertions(+), 8 deletions(-)

diff --git a/bfd/dwarf2.c b/bfd/dwarf2.c
index d1604e12ecf..85560bf9bc6 100644
--- a/bfd/dwarf2.c
+++ b/bfd/dwarf2.c
@@ -3976,19 +3976,20 @@ find_debug_info (bfd *abfd, const struct dwarf_debug_section *debug_sections,
     {
       look = debug_sections[debug_info].uncompressed_name;
       msec = bfd_get_section_by_name (abfd, look);
-      if (msec != NULL)
+      /* Testing SEC_HAS_CONTENTS is an anti-fuzzer measure.  Of
+	 course debug sections always have contents.  */
+      if (msec != NULL && (msec->flags & SEC_HAS_CONTENTS) != 0)
	return msec;

       look = debug_sections[debug_info].compressed_name;
-      if (look != NULL)
-	{
-	  msec = bfd_get_section_by_name (abfd, look);
-	  if (msec != NULL)
-	    return msec;
-	}
+      msec = bfd_get_section_by_name (abfd, look);
+      if (msec != NULL && (msec->flags & SEC_HAS_CONTENTS) != 0)
+	return msec;
+

       for (msec = abfd->sections; msec != NULL; msec = msec->next)
-	if (CONST_STRNEQ (msec->name, GNU_LINKONCE_INFO))
+       if ((msec->flags & SEC_HAS_CONTENTS) != 0
+	    && (msec->name, GNU_LINKONCE_INFO))
	  return msec;

       return NULL;
@@ -3996,6 +3997,9 @@ find_debug_info (bfd *abfd, const struct dwarf_debug_section *debug_sections,

   for (msec = after_sec->next; msec != NULL; msec = msec->next)
     {
+      if ((msec->flags & SEC_HAS_CONTENTS) == 0)
+	continue;
+
       look = debug_sections[debug_info].uncompressed_name;
       if (strcmp (msec->name, look) == 0)
	return msec;
--
2.24.4
