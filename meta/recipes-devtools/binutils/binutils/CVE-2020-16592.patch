From a4faf0368c362bcc1b873ec0a5d23989162b4420 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Thu, 19 Jan 2023 06:25:55 +0000
Subject: [PATCH] PR25823, Use after free in bfd_hash_lookup

PR 25823
* peXXigen.c (_bfd_XXi_swap_sym_in <C_SECTION>): Don't use a
pointer into strings that may be freed for section name, always
allocate a new string.

Upstream-Status: Backport [https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;h=7ecb51549ab1ec22aba5aaf34b70323cf0b8509a]
CVE: CVE-2020-16592
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 bfd/ChangeLog  |  7 +++++++
 bfd/peXXigen.c | 20 ++++++++++----------
 2 files changed, 17 insertions(+), 10 deletions(-)

#diff --git a/bfd/ChangeLog b/bfd/ChangeLog
#index ef17c808731..40f46a95cb2 100644
#--- a/bfd/ChangeLog
#+++ b/bfd/ChangeLog
#@@ -1,3 +1,10 @@
#+2020-04-15  Alan Modra  <amodra@gmail.com>
#+
#+        PR 25823
#+	* peXXigen.c (_bfd_XXi_swap_sym_in <C_SECTION>): Don't use a
#+	pointer into strings that may be freed for section name, always
#+	allocate a new string.
#+
# 2019-02-18  Nick Clifton  <nickc@redhat.com>
# 
# 	Import from the mainline:
diff --git a/bfd/peXXigen.c b/bfd/peXXigen.c
index f1ae83415f3..0360419ac59 100644
--- a/bfd/peXXigen.c
+++ b/bfd/peXXigen.c
@@ -170,25 +170,25 @@ _bfd_XXi_swap_sym_in (bfd * abfd, void * ext1, void * in1)
 	  int unused_section_number = 0;
 	  asection *sec;
 	  flagword flags;
+          size_t name_len;
+          char *sec_name;
 
 	  for (sec = abfd->sections; sec; sec = sec->next)
 	    if (unused_section_number <= sec->target_index)
 	      unused_section_number = sec->target_index + 1;
 
-	  if (name == namebuf)
+          name_len = strlen (name) + 1;
+          sec_name = bfd_alloc (abfd, name_len);
+          if (sec_name == NULL)
 	    {
-	      name = (const char *) bfd_alloc (abfd, strlen (namebuf) + 1);
-	      if (name == NULL)
-		{
-		  _bfd_error_handler (_("%B: out of memory creating name for empty section"),
-				      abfd);
-		  return;
-		}
-	      strcpy ((char *) name, namebuf);
+              _bfd_error_handler (_("%pB: out of memory creating name "
+                                    "for empty section"), abfd);
+              return;
 	    }
+          memcpy (sec_name, name, name_len);
 
 	  flags = SEC_HAS_CONTENTS | SEC_ALLOC | SEC_DATA | SEC_LOAD;
-	  sec = bfd_make_section_anyway_with_flags (abfd, name, flags);
+	  sec = bfd_make_section_anyway_with_flags (abfd, sec_name, flags);
 	  if (sec == NULL)
 	    {
 	      _bfd_error_handler (_("%B: unable to create fake empty section"),
-- 
2.18.2

