From 65cf035b8dc1df5d8020e0b1449514a3c42933e7 Mon Sep 17 00:00:00 2001
From: Alan Modra <amodra@gmail.com>
Date: Mon, 12 Dec 2022 19:01:08 +1030
Subject: [PATCH] PR29892, Field file_table of struct module is uninitialized

	PR 29892
	* vms-alphs.c (new_module): Use bfd_zmalloc to alloc file_table.
	(parse_module): Rewrite file_table reallocation code and clear.

CVE: CVE-2023-25585
Upstream-Status: Backport [https://launchpad.net/ubuntu/+source/binutils/2.34-6ubuntu1.9]
Signed-off-by: Ashish Sharma <asharma@mvista.com>

 bfd/vms-alpha.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

--- binutils-2.34.orig/bfd/vms-alpha.c
+++ binutils-2.34/bfd/vms-alpha.c
@@ -4259,7 +4259,7 @@ new_module (bfd *abfd)
     = (struct module *) bfd_zalloc (abfd, sizeof (struct module));
   module->file_table_count = 16; /* Arbitrary.  */
   module->file_table
-    = bfd_malloc (module->file_table_count * sizeof (struct fileinfo));
+    = bfd_zmalloc (module->file_table_count * sizeof (struct fileinfo));
   return module;
 }
 
@@ -4434,13 +4434,16 @@ parse_module (bfd *abfd, struct module *
 		       src_ptr + DST_S_B_SRC_DF_FILENAME,
 		       ptr + rec_length - (src_ptr + DST_S_B_SRC_DF_FILENAME));
 
-		    while (fileid >= module->file_table_count)
+		    if (fileid >= module->file_table_count)
 		      {
-			module->file_table_count *= 2;
+			unsigned int old_count = module->file_table_count;
+			module->file_table_count += fileid;
 			module->file_table
 			  = bfd_realloc (module->file_table,
 					 module->file_table_count
 					   * sizeof (struct fileinfo));
+			memset (module->file_table + old_count, 0,
+				fileid * sizeof (struct fileinfo));
 		      }
 
 		    module->file_table [fileid].name = filename;
