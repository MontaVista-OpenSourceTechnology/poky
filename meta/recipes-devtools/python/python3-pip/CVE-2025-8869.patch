From: Daniel Leidert <dleidert@debian.org>
Date: Sun, 26 Oct 2025 02:33:54 +0200
Subject: Fix CVE-2025-8869

Backport the patch to fix CVE-2025-8869: pip's tar extraction doesn't check
symbolic links point to extraction directory.

Origin: https://github.com/pypa/pip/commit/f2b92314da012b9fffa36b3f3e67748a37ef464a
Bug: https://github.com/advisories/GHSA-4xh5-x5gv-qwph
Bug-Debian: https://bugs.debian.org/1116336
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2025-8869
Bug-Freexian-Security: https://deb.freexian.com/extended-lts/tracker/CVE-2025-8869

Upstream-Status: Backport from [https://salsa.debian.org/python-team/packages/python-pip/-/commit/40e53bef0384e5b8df14548359323b3adeb8f779]
CVE: CVE-2025-8869
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>

---
 src/pip/_internal/utils/unpacking.py | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/src/pip/_internal/utils/unpacking.py b/src/pip/_internal/utils/unpacking.py
index 7252dc2..b40021b 100644
--- a/src/pip/_internal/utils/unpacking.py
+++ b/src/pip/_internal/utils/unpacking.py
@@ -150,6 +150,20 @@ def unzip_file(filename, location, flatten=True):
         zipfp.close()
 
 
+def is_symlink_target_in_tar(tar: tarfile.TarFile, tarinfo: tarfile.TarInfo) -> bool:
+    """Check if the file pointed to by the symbolic link is in the tar archive"""
+    linkname = os.path.join(os.path.dirname(tarinfo.name), tarinfo.linkname)
+
+    linkname = os.path.normpath(linkname)
+    linkname = linkname.replace("\\", "/")
+
+    try:
+        tar.getmember(linkname)
+        return True
+    except KeyError:
+        return False
+
+
 def untar_file(filename, location):
     # type: (str, str) -> None
     """
@@ -196,6 +210,14 @@ def untar_file(filename, location):
             if member.isdir():
                 ensure_dir(path)
             elif member.issym():
+                if not is_symlink_target_in_tar(tar, member):
+                    message = (
+                        "The tar file ({}) has a file ({}) trying to install "
+                        "outside target directory ({})"
+                    )
+                    raise InstallationError(
+                        message.format(filename, member.name, member.linkname)
+                    )
                 try:
                     # https://github.com/python/typeshed/issues/2673
                     tar._extract_member(member, path)  # type: ignore
-- 
2.34.1

