From 1351fdb58bef5f63feda1dcd3585fb99079c1746 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 21 Dec 2022 12:18:21 +0000
Subject: [PATCH] setup: fix safe.directory key not being checked

It seems that nothing is ever checking to make sure the safe directories
in the configs actually have the key safe.directory, so some unrelated
config that has a value with a certain directory would also make it a
safe directory.

Signed-off-by: Matheus Valadares <me@m28.io>
Signed-off-by: Derrick Stolee <derrickstolee@github.com>
Signed-off-by: Junio C Hamano <gitster@pobox.com>

Upstream-Status: Backport [https://github.com/git/git/commit/bb50ec3cc300eeff3aba7a2bea145aabdb477d31]
CVE: CVE-2022-24765
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 setup.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/setup.c b/setup.c
index ed0285e..3a7a27f 100644
--- a/setup.c
+++ b/setup.c
@@ -871,6 +871,9 @@ static int safe_directory_cb(const char *key, const char *value, void *d)
 {
        struct safe_directory_data *data = d;
 
+       if (strcmp(key, "safe.directory"))
+               return 0;
+
        if (!value || !*value)
                data->is_safe = 0;
        else {
-- 
2.18.2

