From 111fb0f2f1b252d29e179d8220bcd12fc7ffdecc Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 21 Dec 2022 08:12:58 +0000
Subject: [PATCH] config: add read_very_early_config()

Created an even lighter version of read_early_config() that
only looks at system and global config settings.  It omits
repo-local, worktree-local, and command-line settings.

Signed-off-by: Jeff Hostetler <jeffhost@microsoft.com>
Signed-off-by: Junio C Hamano <gitster@pobox.com>

Upstream-Status: Backport [https://github.com/git/git/commit/800a7f99a8776b18a48cf9c1b0f9418bf4644bbd]
CVE: CVE-2022-24765
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 config.c | 16 ++++++++++++++++
 config.h |  4 ++++
 2 files changed, 20 insertions(+)

diff --git a/config.c b/config.c
index fbbf0f8..c78800d 100644
--- a/config.c
+++ b/config.c
@@ -1687,6 +1687,22 @@ static int do_git_config_sequence(const struct config_options *opts,
 	return ret;
 }
 
+/*
+ * Read config but only enumerate system and global settings.
+ * Omit any repo-local, worktree-local, or command-line settings.
+ */
+void read_very_early_config(config_fn_t cb, void *data)
+{
+       struct config_options opts = { 0 };
+
+       opts.respect_includes = 1;
+       opts.ignore_repo = 1;
+       opts.ignore_worktree = 1;
+       opts.ignore_cmdline = 1;
+
+       config_with_options(cb, data, NULL, &opts);
+}
+
 int config_with_options(config_fn_t fn, void *data,
 			struct git_config_source *config_source,
 			const struct config_options *opts)
diff --git a/config.h b/config.h
index cdac2fc..fbd8251 100644
--- a/config.h
+++ b/config.h
@@ -50,6 +50,9 @@ typedef int (*config_parser_event_fn_t)(enum config_event_t type,
 
 struct config_options {
 	unsigned int respect_includes : 1;
+        unsigned int ignore_repo : 1;
+        unsigned int ignore_worktree : 1;
+        unsigned int ignore_cmdline : 1;
 	const char *commondir;
 	const char *git_dir;
 	config_parser_event_fn_t event_fn;
@@ -69,6 +72,7 @@ extern int git_config_from_blob_oid(config_fn_t fn, const char *name,
 extern void git_config_push_parameter(const char *text);
 extern int git_config_from_parameters(config_fn_t fn, void *data);
 extern void read_early_config(config_fn_t cb, void *data);
+extern void read_very_early_config(config_fn_t cb, void *data);
 extern void git_config(config_fn_t fn, void *);
 extern int config_with_options(config_fn_t fn, void *,
 			       struct git_config_source *config_source,
-- 
2.18.2

