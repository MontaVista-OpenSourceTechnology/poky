From b85732d31a52827b7e2e8e194703e63fdb0c4a9f Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Wed, 20 Apr 2022 12:10:58 +0530
Subject: [PATCH] CVE-2022-26353

Upstream-Status: Backport from https://lists.nongnu.org/archive/html/qemu-devel/2022-03/msg02438.html

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 hw/net/virtio-net.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/hw/net/virtio-net.c b/hw/net/virtio-net.c
index 245a538b..d8728c71 100644
--- a/hw/net/virtio-net.c
+++ b/hw/net/virtio-net.c
@@ -1294,7 +1294,8 @@ static ssize_t virtio_net_receive_rcu(NetClientState *nc, const uint8_t *buf,
 
 err:
     for (j = 0; j < i; j++) {
-        g_free(elems[j]);
+	virtqueue_detach_element(q->rx_vq, elems[j], lens[j]);
+	g_free(elems[j]);
     }
 
     return err;
-- 
2.25.1

