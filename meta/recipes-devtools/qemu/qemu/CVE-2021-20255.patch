From a25dde5a45be949440fa8de6682ba34a43c21dcd Mon Sep 17 00:00:00 2001
From: Markus Koschany <apo@debian.org>
Date: Sat, 10 Apr 2021 12:30:48 +0200
Subject: [PATCH 6/7] CVE-2021-20255

Bug-Debian: https://bugs.debian.org/984451
Origin: https://lists.gnu.org/archive/html/qemu-devel/2021-02/msg06098.html

Upstream-status: Backport
CVE: CVE-2021-20255
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 hw/net/eepro100.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/hw/net/eepro100.c b/hw/net/eepro100.c
index 5a4774a..a9f571b 100644
--- a/hw/net/eepro100.c
+++ b/hw/net/eepro100.c
@@ -276,6 +276,9 @@ typedef struct {
     /* Quasi static device properties (no need to save them). */
     uint16_t stats_size;
     bool has_extended_tcb_support;
+
+    /* Flag to avoid recursions. */
+    bool busy;
 } EEPRO100State;
 
 /* Word indices in EEPROM. */
@@ -869,6 +872,14 @@ static void action_command(EEPRO100State *s)
        Therefore we limit the number of iterations. */
     unsigned max_loop_count = 16;
 
+    if (s->busy) {
+        /* Prevent recursions. */
+        logout("recursion in %s:%u\n", __FILE__, __LINE__);
+        return;
+    }
+
+    s->busy = true;
+
     for (;;) {
         bool bit_el;
         bool bit_s;
@@ -965,6 +976,7 @@ static void action_command(EEPRO100State *s)
     }
     TRACE(OTHER, logout("CU list empty\n"));
     /* List is empty. Now CU is idle or suspended. */
+    s->busy = false;
 }
 
 static void eepro100_cu_command(EEPRO100State * s, uint8_t val)
-- 
2.7.4

