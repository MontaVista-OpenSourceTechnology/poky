From 92128fc0e65c045279c317f412da6f9d9ea85ff6 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Tue, 16 Nov 2021 11:17:49 +0530
Subject: [PATCH] CVE-2021-3713

Upstream-Status: Backport from https://lists.nongnu.org/archive/html/qemu-devel/2021-08/msg02766.html

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 hw/usb/dev-uas.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/hw/usb/dev-uas.c b/hw/usb/dev-uas.c
index fffc4243..eaba6ba9 100644
--- a/hw/usb/dev-uas.c
+++ b/hw/usb/dev-uas.c
@@ -827,6 +827,9 @@ static void usb_uas_handle_data(USBDevice *dev, USBPacket *p)
         }
         break;
     case UAS_PIPE_ID_STATUS:
+        if (p->stream > UAS_MAX_STREAMS) {
+            goto err_stream;
+        }
         if (p->stream) {
             QTAILQ_FOREACH(st, &uas->results, next) {
                 if (st->stream == p->stream) {
@@ -854,6 +857,9 @@ static void usb_uas_handle_data(USBDevice *dev, USBPacket *p)
         break;
     case UAS_PIPE_ID_DATA_IN:
     case UAS_PIPE_ID_DATA_OUT:
+        if (p->stream > UAS_MAX_STREAMS) {
+            goto err_stream;
+        }
         if (p->stream) {
             req = usb_uas_find_request(uas, p->stream);
         } else {
@@ -889,6 +895,10 @@ static void usb_uas_handle_data(USBDevice *dev, USBPacket *p)
         p->status = USB_RET_STALL;
         break;
     }
+    err_stream:
+	error_report("%s: invalid stream %d", __func__, p->stream);
+	p->status = USB_RET_STALL;
+	return;
 }
 
 static void usb_uas_unrealize(USBDevice *dev, Error **errp)
-- 
2.25.1

