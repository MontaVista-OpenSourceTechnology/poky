From 481d8346db728d38017a1b3c1090f51a421d4f11 Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Tue, 9 Nov 2021 15:03:47 +0530
Subject: [PATCH 1/8] ide: ahci: add check to avoid null dereference

AHCI emulator while committing DMA buffer in ahci_commit_buf()
may do a NULL dereference if the command header 'ad->cur_cmd'
is null. Add check to avoid it.

Reported-by: Bugs SysSec <address@hidden>
Signed-off-by: Prasad J Pandit <address@hidden>

Upstream-Status: Backport [https://lists.gnu.org/archive/html/qemu-devel/2019-08/msg01358.html]
CVE: CVE-2019-12067
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 hw/ide/ahci.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/hw/ide/ahci.c b/hw/ide/ahci.c
index 406a1b5..ec6a673 100644
--- a/hw/ide/ahci.c
+++ b/hw/ide/ahci.c
@@ -1386,8 +1386,10 @@ static void ahci_commit_buf(IDEDMA *dma, uint32_t tx_bytes)
 {
     AHCIDevice *ad = DO_UPCAST(AHCIDevice, dma, dma);
 
-    tx_bytes += le32_to_cpu(ad->cur_cmd->status);
-    ad->cur_cmd->status = cpu_to_le32(tx_bytes);
+    if (ad->cur_cmd) {
+        tx_bytes += le32_to_cpu(ad->cur_cmd->status);
+        ad->cur_cmd->status = cpu_to_le32(tx_bytes);
+    }
 }
 
 static int ahci_dma_rw_buf(IDEDMA *dma, int is_write)
-- 
2.7.4

