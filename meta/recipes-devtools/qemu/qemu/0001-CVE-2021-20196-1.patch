From cd2396a2338767ba4ee21871bcb0dd46375468ec Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Tue, 11 Oct 2022 04:07:42 +0000
Subject: [PATCH] hw/block/fdc: Extract blk_create_empty_drive()

We are going to re-use this code in the next commit,
so extract it as a new blk_create_empty_drive() function.

Inspired-by: Hanna Reitz <hreitz@redhat.com>
Signed-off-by: Philippe Mathieu-Daud√© <philmd@redhat.com>
Message-id: 20211124161536.631563-2-philmd@redhat.com
Signed-off-by: John Snow <jsnow@redhat.com>

Upstream-Status: Backport from https://gitlab.com/qemu-project/qemu/-/commit/b154791e7b6d4ca5cdcd54443484d97360bd7ad2
CVE: CVE-2021-20196
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 hw/block/fdc.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/hw/block/fdc.c b/hw/block/fdc.c
index 40112907..3722f662 100644
--- a/hw/block/fdc.c
+++ b/hw/block/fdc.c
@@ -54,6 +54,12 @@
     } while (0)
 
 
+/* Anonymous BlockBackend for empty drive */
+static BlockBackend *blk_create_empty_drive(void)
+{
+    return blk_new(0, BLK_PERM_ALL);
+}
+
 /********************************************************/
 /* qdev floppy bus                                      */
 
@@ -547,8 +553,7 @@ static int floppy_drive_init(DeviceState *qdev)
     }
 
     if (!dev->conf.blk) {
-        /* Anonymous BlockBackend for an empty drive */
-        dev->conf.blk = blk_new(0, BLK_PERM_ALL);
+        dev->conf.blk = blk_create_empty_drive();
         ret = blk_attach_dev(dev->conf.blk, qdev);
         assert(ret == 0);
     }
-- 
2.18.2

