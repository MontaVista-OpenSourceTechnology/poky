From 550d4a229f191825cf70247f9d47324597635239 Mon Sep 17 00:00:00 2001
From: Markus Koschany <apo@debian.org>
Date: Wed, 1 Sep 2021 14:41:06 +0200
Subject: [PATCH 4/7] CVE-2021-3682

Bug-Debian: https://bugs.debian.org/991911
Origin: https://gitlab.com/qemu-project/qemu/-/commit/5e796671e6b8d5de4b0b423dce1b3eba144a92c9

Upstream-status: Backport
CVE: CVE-2021-3682
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 hw/usb/redirect.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/usb/redirect.c b/hw/usb/redirect.c
index ec9f042..9a85e89 100644
--- a/hw/usb/redirect.c
+++ b/hw/usb/redirect.c
@@ -457,7 +457,7 @@ static int bufp_alloc(USBRedirDevice *dev, uint8_t *data, uint16_t len,
     if (dev->endpoint[EP2I(ep)].bufpq_dropping_packets) {
         if (dev->endpoint[EP2I(ep)].bufpq_size >
                 dev->endpoint[EP2I(ep)].bufpq_target_size) {
-            free(data);
+            free(free_on_destroy);
             return -1;
         }
         dev->endpoint[EP2I(ep)].bufpq_dropping_packets = 0;
-- 
2.7.4

