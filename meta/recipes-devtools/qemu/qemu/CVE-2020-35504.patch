From 17e97d92389a5d2299eed032f638836724b61a74 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Mon, 17 Oct 2022 10:35:05 +0000
Subject: [PATCH] esp: always check current_req is not NULL before use in DMA callbacks

After issuing a SCSI command the SCSI layer can call the SCSIBusInfo .cancel
callback which resets both current_req and current_dev to NULL. If any data
is left in the transfer buffer (async_len != 0) then the next TI (Transfer
Information) command will attempt to reference the NULL pointer causing a
segfault.

Buglink: https://bugs.launchpad.net/qemu/+bug/1910723
Buglink: https://bugs.launchpad.net/qemu/+bug/1909247
Signed-off-by: Mark Cave-Ayland <mark.cave-ayland@ilande.co.uk>
Tested-by: Alexander Bulekov <alxndr@bu.edu>
Message-Id: <20210407195801.685-2-mark.cave-ayland@ilande.co.uk>

Upstream-Status: Backport [https://git.qemu.org/?p=qemu.git;a=commit;h=0db895361b8a82e1114372ff9f48]
CVE: CVE-2020-35504
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 hw/scsi/esp.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/hw/scsi/esp.c b/hw/scsi/esp.c
index 979a2017..14ab61c5 100644
--- a/hw/scsi/esp.c
+++ b/hw/scsi/esp.c
@@ -253,6 +253,9 @@ static void esp_do_dma(ESPState *s)
         s->dma_memory_read(s->dma_opaque, &s->cmdbuf[s->cmdlen], len);
         return;
     }
+    if (!s->current_req) {
+        return;
+    }
     if (s->async_len == 0) {
         /* Defer until data is available.  */
         return;
@@ -266,6 +269,11 @@ static void esp_do_dma(ESPState *s)
     } else {
         s->dma_memory_write(s->dma_opaque, s->async_buf, len);
     }
+
+    if (!s->current_req) {
+        return;
+    }
+
     s->dma_left -= len;
     s->async_buf += len;
     s->async_len -= len;
-- 
2.18.2

