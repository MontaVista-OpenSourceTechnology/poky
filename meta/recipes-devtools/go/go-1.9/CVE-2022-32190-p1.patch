From 1b8f0854977e969c75bf0deedf082f03a55ca759 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Tue, 18 Oct 2022 10:13:38 +0000
Subject: [PATCH] net/url: add JoinPath, URL.JoinPath

Builds on CL 332209.

Fixes #47005

Change-Id: I82708dede05d79a196ca63f5a4e7cb5ac9a041ea
GitHub-Last-Rev: 51b7350
GitHub-Pull-Request: #50383
Reviewed-on: https://go-review.googlesource.com/c/go/+/374654
Reviewed-by: Russ Cox <rsc@golang.org>
Auto-Submit: Russ Cox <rsc@golang.org>
Trust: Ian Lance Taylor <iant@golang.org>
Reviewed-by: Damien Neil <dneil@google.com>
Run-TryBot: Ian Lance Taylor <iant@golang.org>
TryBot-Result: Gopher Robot <gobot@golang.org>

Upstream-Status: Backport [https://github.com/golang/go/commit/604140d93111f89911e17cb147dcf6a02d2700d0]
CVE: CVE-2022-32190
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 src/net/url/url.go | 23 +++++++++++++++++++++++
 1 file changed, 23 insertions(+)

diff --git a/src/net/url/url.go b/src/net/url/url.go
index f07c43d..f28032b 100644
--- a/src/net/url/url.go
+++ b/src/net/url/url.go
@@ -14,6 +14,7 @@ import (
 	"bytes"
 	"errors"
 	"fmt"
+        "path"
 	"sort"
 	"strconv"
 	"strings"
@@ -1059,6 +1060,17 @@ func (u *URL) UnmarshalBinary(text []byte) error {
 	return nil
 }
 
+// JoinPath returns a new URL with the provided path elements joined to
+// any existing path and the resulting path cleaned of any ./ or ../ elements.
+func (u *URL) JoinPath(elem ...string) *URL {
+      url := *u
+      if len(elem) > 0 {
+              elem = append([]string{u.Path}, elem...)
+              url.setPath(path.Join(elem...))
+      }
+      return &url
+}
+
 // validUserinfo reports whether s is a valid userinfo string per RFC 3986
 // Section 3.2.1:
 //     userinfo    = *( unreserved / pct-encoded / sub-delims / ":" )
@@ -1099,3 +1111,14 @@ func stringContainsCTLByte(s string) bool {
 	}
 	return false
 }
+
+// JoinPath returns a URL string with the provided path elements joined to
+// the existing path of base and the resulting path cleaned of any ./ or ../ elements.
+func JoinPath(base string, elem ...string) (result string, err error) {
+      url, err := Parse(base)
+      if err != nil {
+              return
+      }
+      result = url.JoinPath(elem...).String()
+      return
+}
-- 
2.18.2

