From 6fc23a3cff5e38ff72923fee50f51254dcdc6e93 Mon Sep 17 00:00:00 2001
From: Roland Shoemaker <roland@golang.org>
Date: Tue, 21 Jan 2025 16:03:14 -0800
Subject: [PATCH] crypto/internal/fips140/nistec: make p256NegCond constant
 time on ppc64le

Remove the branching instruction from p256NegCond which made it variable
time. The technique used matches that used in p256MovCond.

Fixes #71383
Fixes CVE-2025-22866

Change-Id: Ibc2a46814d856cbbdaf6cc0c5a415ed5d42ca793
Reviewed-on: https://go-review.googlesource.com/c/go/+/643735
Reviewed-by: David Chase <drchase@google.com>
Reviewed-by: Filippo Valsorda <filippo@golang.org>
Reviewed-by: Paul Murphy <murp@ibm.com>
LUCI-TryBot-Result: Go LUCI <golang-scoped@luci-project-accounts.iam.gserviceaccount.com>

Upstream-Status: Backport from [https://github.com/golang/go/commit/6fc23a3cff5e38ff72923fee50f51254dcdc6e93]
CVE: CVE-2025-22866
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>
---
 src/crypto/elliptic/p256_asm_ppc64le.s | 28 ++++++++++++++++----------
 1 file changed, 17 insertions(+), 11 deletions(-)

diff --git a/src/crypto/elliptic/p256_asm_ppc64le.s b/src/crypto/elliptic/p256_asm_ppc64le.s
index 924e365..5372e31 100644
--- a/src/crypto/elliptic/p256_asm_ppc64le.s
+++ b/src/crypto/elliptic/p256_asm_ppc64le.s
@@ -194,19 +194,23 @@ GLOBL byteswap<>+0(SB), RODATA, $16
 #define SEL1  V5
 #define SEL1_ VS37
 #define CAR1  V6
-//
-// iff cond == 1 val <- -val
-//
+
+#define SEL    V8
+#define ZER    V9
+
+// func p256NegCond(val *p256Point, cond int)
 TEXT ·p256NegCond(SB), NOSPLIT, $0-16
 	MOVD val+0(FP), P1ptr
 	MOVD $16, R16
-	MOVD $32, R17
-	MOVD $48, R18
-	MOVD $40, R19
 
-	MOVD cond+8(FP), R6
-	CMP  $0, R6
-	BC   12, 2, LR      // just return if cond == 0
+	// Copy cond into SEL (cond is R1 + 8 (cond offset) + 32)
+	MOVD $40, R17
+	LXVDSX (R1)(R17), SEL
+	// Zeroize ZER
+	VSPLTISB $0, ZER
+	// SEL controls whether to return the original value (Y1H/Y1L)
+	// or the negated value (T1H/T1L).
+	VCMPEQUD SEL, ZER, SEL
 
 	MOVD $p256mul<>+0x00(SB), CPOOL
 
@@ -226,8 +230,8 @@ TEXT ·p256NegCond(SB), NOSPLIT, $0-16
 	VSUBUQM  PL, Y1L, T1L       // subtract part2 giving result
 	VSUBEUQM PH, Y1H, CAR1, T1H // subtract part1 using carry from part2
 
-	VPERM T1H, T1H, SWAP, T1H
-	VPERM T1L, T1L, SWAP, T1L
+	VSEL T1H, Y1H, SEL, T1H
+	VSEL T1L, Y1L, SEL, T1L
 
 	STXVD2X T1L_, (R17+P1ptr)
 	STXVD2X T1H_, (R18+P1ptr)
@@ -250,6 +254,8 @@ TEXT ·p256NegCond(SB), NOSPLIT, $0-16
 #undef SEL1
 #undef SEL1_
 #undef CAR1
+#undef SEL
+#undef ZER
 
 //
 // if cond == 0 res <-b else res <-a
-- 
2.34.1

