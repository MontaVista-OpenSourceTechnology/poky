commit 9e2238adc1cad1fba5aad23bc8c2a6c2a65794d2
Author: Sebastian Dr√∂ge <sebastian@centricular.com>
Date:   Thu May 8 09:14:15 2025 +0300

    subparse: Check for valid UTF-8 before cleaning up lines and check for regex replace errors
    
    Fixes https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/4418
    Fixes CVE-2025-47807
    
    Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/9132>

Upstream-Status: Backport from [https://gitlab.freedesktop.org/gstreamer/gstreamer/-/commit/9e2238adc1cad1fba5aad23bc8c2a6c2a65794d2]
CVE: CVE-2025-47807
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>
---
 gst/subparse/gstsubparse.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/gst/subparse/gstsubparse.c b/gst/subparse/gstsubparse.c
index 6a19112..9b73ef5 100644
--- a/gst/subparse/gstsubparse.c
+++ b/gst/subparse/gstsubparse.c
@@ -702,6 +702,12 @@ subrip_unescape_formatting (gchar * txt, gconstpointer allowed_tags_ptr,
   res = g_regex_replace (tag_regex, txt, strlen (txt), 0,
       replace_pattern, 0, NULL);
 
+  /* Replacing can fail. Return an empty string in that case. */
+  if (!res) {
+    strcpy (txt, "");
+    return;
+  }
+
   /* res will always be shorter than the input or identical, so this
    * copy is OK */
   strcpy (txt, res);
@@ -1069,6 +1075,10 @@ parse_subrip (ParserState * state, const gchar * line)
         g_string_append_c (state->buf, '\n');
       g_string_append (state->buf, line);
       if (strlen (line) == 0) {
+        if (!g_utf8_validate (state->buf->str, state->buf->len, NULL)) {
+          g_string_truncate (state->buf, 0);
+          return NULL;
+        }
         ret = g_markup_escape_text (state->buf->str, state->buf->len);
         g_string_truncate (state->buf, 0);
         state->state = 0;
-- 
2.34.1

