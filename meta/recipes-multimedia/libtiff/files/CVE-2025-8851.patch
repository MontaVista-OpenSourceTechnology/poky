From 8a7a48d7a645992ca83062b3a1873c951661e2b3 Mon Sep 17 00:00:00 2001 
From: Lee Howard <faxguy@howardsilvan.com> 
Date: Sun, 11 Aug 2024 16:01:07 +0000 
Subject: [PATCH] Attempt to address tiffcrop Coverity scan issues 1605444,  1605445, and 1605449.

Upstream-Status: Backport from [https://gitlab.com/libtiff/libtiff/-/commit/8a7a48d7a645992ca83062b3a1873c951661e2b3]
CVE: CVE-2025-8851
Signed-off-by: Milan Satpathy <msatpathy@mvista.com>
---
 tools/tiffcrop.c | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/tools/tiffcrop.c b/tools/tiffcrop.c
index 3b9234f..325bd53 100644
--- a/tools/tiffcrop.c
+++ b/tools/tiffcrop.c
@@ -4911,7 +4911,14 @@ static int readSeparateStripsIntoBuffer (TIFF *in, uint8 *obuf, uint32 length,
       buff = srcbuffs[s];
       strip = (s * strips_per_sample) + j; 
       bytes_read = TIFFReadEncodedStrip (in, strip, buff, stripsize);
+      if (bytes_read < 0)
+      {
+          rows_this_strip = 0;
+      }
+      else
+      {
       rows_this_strip = (uint32)(bytes_read / src_rowsize);
+      }
       if (bytes_read < 0 && !ignore)
         {
         TIFFError(TIFFFileName(in),
@@ -5322,14 +5329,14 @@ computeInputPixelOffsets(struct crop_mask *crop, struct image_data *image,
       rmargin = _TIFFClampDoubleToUInt32(crop->margins[3] * scale * xres);
       }
 
-    if ((lmargin + rmargin) > image->width)
+      if (lmargin == 0xFFFFFFFFU || rmargin == 0xFFFFFFFFU || (lmargin + rmargin) > image->width)
       {
       TIFFError("computeInputPixelOffsets", "Combined left and right margins exceed image width");
       lmargin = (uint32) 0;
       rmargin = (uint32) 0;
       return (-1);
       }
-    if ((tmargin + bmargin) > image->length)
+      if (tmargin == 0xFFFFFFFFU || bmargin == 0xFFFFFFFFU || (tmargin + bmargin) > image->length)
       {
       TIFFError("computeInputPixelOffsets", "Combined top and bottom margins exceed image length"); 
       tmargin = (uint32) 0; 
@@ -5819,14 +5826,14 @@ computeOutputPixelOffsets (struct crop_mask *crop, struct image_data *image,
       vmargin = _TIFFClampDoubleToUInt32(page->vmargin * scale * ((image->bps + 7) / 8));
       }
 
-    if ((hmargin * 2.0) > (pwidth * page->hres))
+      if (hmargin == 0xFFFFFFFFU || (hmargin * 2.0) > (pwidth * page->hres))
       {
       TIFFError("computeOutputPixelOffsets", 
                 "Combined left and right margins exceed page width");
       hmargin = (uint32) 0;
       return (-1);
       }
-    if ((vmargin * 2.0) > (plength * page->vres))
+      if (vmargin == 0xFFFFFFFFU || (vmargin * 2.0) > (plength * page->vres))
       {
       TIFFError("computeOutputPixelOffsets", 
                 "Combined top and bottom margins exceed page length"); 
-- 
2.34.1

