From ef735011dfe322f480895176b0c9fd423a2bd87f Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Mon, 1 Aug 2022 10:06:02 +0000
Subject: [PATCH] CVE-2022-0865

tif_jbig.c: fix crash when reading a file with multiple IFD in memory-mapped mode and when bit reversal is needed (fixes #385)

Upstream-Status: Backport from https://gitlab.com/libtiff/libtiff/-/commit/a1c933dabd0e1c54a412f3f84ae0aa58115c6067
CVE: CVE-2022-0865
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 libtiff/tif_jbig.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/libtiff/tif_jbig.c b/libtiff/tif_jbig.c
index 6d52215..40111e7 100644
--- a/libtiff/tif_jbig.c
+++ b/libtiff/tif_jbig.c
@@ -190,6 +190,16 @@ int TIFFInitJBIG(TIFF* tif, int scheme)
 	 */
 	tif->tif_flags |= TIFF_NOBITREV;
 	tif->tif_flags &= ~TIFF_MAPPED;
+        /* We may have read from a previous IFD and thus set TIFF_BUFFERMMAP and
+         * cleared TIFF_MYBUFFER. It is necessary to restore them to their initial
+         * value to be consistent with the state of a non-memory mapped file.
+         */
+        if (tif->tif_flags&TIFF_BUFFERMMAP) {
+                tif->tif_rawdata = NULL;
+                tif->tif_rawdatasize = 0;
+                tif->tif_flags &= ~TIFF_BUFFERMMAP;
+                tif->tif_flags |= TIFF_MYBUFFER;
+        }
 
 	/* Setup the function pointers for encode, decode, and cleanup. */
 	tif->tif_setupdecode = JBIGSetupDecode;
-- 
2.18.2

