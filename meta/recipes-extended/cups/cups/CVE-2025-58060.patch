From: Thorsten Alteholz <debian@alteholz.de>
Date: Wed, 10 Sep 2025 10:46:21 +0200
Subject: fix authentication bypass with AuthType negotiate

Upstream-Status: Backport [import from debian https://salsa.debian.org/printing-team/cups/-/blob/debian/bullseye/debian/patches/0027-CVE-2025-58060-fix-authentication-bypass-with-AuthType-negotiate.patch?ref_type=heads
Upstream commit https://github.com/OpenPrinting/cups/commit/595d691075b1d396d2edfaa0a8fd0873a0a1f221]
CVE: CVE-2025-58060
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 scheduler/auth.c | 21 ++++++++++++++++++++-
 1 file changed, 20 insertions(+), 1 deletion(-)

Index: cups-2.3.3op2/scheduler/auth.c
===================================================================
--- cups-2.3.3op2.orig/scheduler/auth.c	2025-09-10 14:37:32.455183214 +0200
+++ cups-2.3.3op2/scheduler/auth.c	2025-09-10 14:37:32.455183214 +0200
@@ -505,6 +505,16 @@
     int	userlen;			/* Username:password length */
 
 
+   /*
+    * Only allow Basic if enabled...
+    */
+
+    if (type != CUPSD_AUTH_BASIC)
+    {
+      cupsdLogClient(con, CUPSD_LOG_ERROR, "Basic authentication is not enabled.");
+      return;
+    }
+
     authorization += 5;
     while (isspace(*authorization & 255))
       authorization ++;
@@ -550,10 +560,6 @@
     * Validate the username and password...
     */
 
-    switch (type)
-    {
-      default :
-      case CUPSD_AUTH_BASIC :
           {
 #if HAVE_LIBPAM
 	   /*
@@ -707,8 +713,6 @@
           }
 
 	  cupsdLogClient(con, CUPSD_LOG_DEBUG, "Authorized as \"%s\" using Basic.", username);
-          break;
-    }
 
     con->type = type;
   }
@@ -726,6 +730,16 @@
     gss_name_t		client_name;	/* Client name */
 
 
+   /*
+    * Only allow Kerberos if enabled...
+    */
+
+    if (type != CUPSD_AUTH_NEGOTIATE)
+    {
+      cupsdLogClient(con, CUPSD_LOG_ERROR, "Kerberos authentication is not enabled.");
+      return;
+    }
+
 #  ifdef __APPLE__
    /*
     * If the weak-linked GSSAPI/Kerberos library is not present, don't try
