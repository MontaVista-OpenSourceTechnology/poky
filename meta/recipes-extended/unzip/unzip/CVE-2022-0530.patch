From 777b1dbe70ec2d03b566a80462e9cd3cb7a65fd5 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Fri, 5 Aug 2022 10:56:45 +0530
Subject: [PATCH 2/2] CVE-2022-0530

Upstream-Status : Backport [https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1010355]
CVE: CVE-2022-0530
Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 fileio.c  | 3 +++
 process.c | 2 ++
 2 files changed, 5 insertions(+)

diff --git a/fileio.c b/fileio.c
index bd7246e..3e4017b 100644
--- a/fileio.c
+++ b/fileio.c
@@ -2354,6 +2354,9 @@ int do_string(__G__ length, option)   /* return PK-type error code */
                   /* convert UTF-8 to local character set */
                   fn = utf8_to_local_string(G.unipath_filename,
                                             G.unicode_escape_all);
+                  if (fn == NULL)
+                    return PK_ERR;
+
                   /* make sure filename is short enough */
                   if (strlen(fn) >= FILNAMSIZ) {
                     fn[FILNAMSIZ - 1] = '\0';
diff --git a/process.c b/process.c
index 4cb21a3..1c03356 100644
--- a/process.c
+++ b/process.c
@@ -2597,6 +2597,8 @@ char *utf8_to_local_string(utf8_string, escape_all)
   int escape_all;
 {
   zwchar *wide = utf8_to_wide_string(utf8_string);
+  if (wide == NULL)
+    return NULL;
   char *loc = wide_to_local_string(wide, escape_all);
   free(wide);
   return loc;
-- 
2.25.1

