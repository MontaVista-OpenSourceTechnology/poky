From 8474e1d6b896e35741d3c608ea5c21deeec1078f Mon Sep 17 00:00:00 2001
From: Zdenek Hutyra <zhutyra@centrum.cz>
Date: Mon, 13 Jan 2025 09:15:01 +0000
Subject: [PATCH] Bug 708241: Fix potential Buffer overflow with DollarBlend

During serializing a multiple master font for passing to Freetype.

Use CVE-2025-27830

Upstream-Status: Backport [import from ubuntu https://git.launchpad.net/ubuntu/+source/ghostscript/tree/debian/patches/CVE-2025-27830.patch?h=ubuntu/focal-security
Upstream commit https://cgit.ghostscript.com/cgi-bin/cgit.cgi/ghostpdl.git/commit/?id=8474e1d6b896e35741d3c608ea5c21deeec1078f]
CVE: CVE-2025-27830
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 base/write_t1.c | 5 +++--
 psi/zfapi.c     | 4 ++++
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/base/write_t1.c b/base/write_t1.c
index 832fd3b..a9c4672 100644
--- a/base/write_t1.c
+++ b/base/write_t1.c
@@ -279,6 +279,7 @@ write_main_dictionary(gs_fapi_font * a_fapi_font, WRF_output * a_output,
     WRF_wbyte(a_fapi_font->memory, a_output, '\n');
     if (is_MM_font(a_fapi_font)) {
         short x, x2;
+        unsigned short ux;
         float x1;
         uint i, j, entries;
         char Buffer[255];
@@ -373,14 +374,14 @@ write_main_dictionary(gs_fapi_font * a_fapi_font, WRF_output * a_output,
          * be because the "get_proc" method below was missing the code to handle PS name
          * objects.
          */
-        if ((x =
+        if ((ux =
              a_fapi_font->get_word(a_fapi_font,
                                    gs_fapi_font_feature_DollarBlend_length,
                                    0)) > 0) {
             WRF_wstring(a_fapi_font->memory, a_output, "/$Blend {");
 
             if (a_output->m_count)
-                a_output->m_count += x;
+                a_output->m_count += ux;
             x = a_fapi_font->get_proc(a_fapi_font,
                                       gs_fapi_font_feature_DollarBlend, 0,
                                       (char *)a_output->m_pos);
diff --git a/psi/zfapi.c b/psi/zfapi.c
index 8d87153..f048966 100644
--- a/psi/zfapi.c
+++ b/psi/zfapi.c
@@ -617,6 +617,10 @@ FAPI_FF_get_word(gs_fapi_font *ff, gs_fapi_font_feature var_id, int index)
                         default:
                             break;
                     }
+
+                    if (length > max_ushort) {
+                        return 0;
+                    }
                 }
                 return length;
             }
-- 
2.18.2

