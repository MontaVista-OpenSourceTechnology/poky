From 8d0a59b7494565b9b5f5be21ab8f4257c4a47a25 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Wed, 7 Dec 2022 04:42:58 +0000
Subject: [PATCH] libarchive: Handle a calloc returning NULL (fixes #1754)

Upstream-Status: Backport [https://github.com/libarchive/libarchive/commit/bff38efe8c110469c5080d387bec62a6ca15b1a5]
CVE: CVE-2022-36227
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 libarchive/archive_write.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/libarchive/archive_write.c b/libarchive/archive_write.c
index 0634a22..314f4da 100644
--- a/libarchive/archive_write.c
+++ b/libarchive/archive_write.c
@@ -211,6 +211,10 @@ __archive_write_allocate_filter(struct archive *_a)
 	struct archive_write_filter *f;
 
 	f = calloc(1, sizeof(*f));
+
+        if (f == NULL)
+                return (NULL);
+
 	f->archive = _a;
 	if (a->filter_first == NULL)
 		a->filter_first = f;
@@ -473,6 +477,10 @@ archive_write_open(struct archive *_a, void *client_data,
 	a->client_data = client_data;
 
 	client_filter = __archive_write_allocate_filter(_a);
+
+        if (client_filter == NULL)
+                return (ARCHIVE_FATAL);
+
 	client_filter->open = archive_write_client_open;
 	client_filter->write = archive_write_client_write;
 	client_filter->close = archive_write_client_close;
-- 
2.18.2

