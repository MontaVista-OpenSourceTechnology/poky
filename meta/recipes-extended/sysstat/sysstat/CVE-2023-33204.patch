From 954ff2e2673cef48f0ed44668c466eab041db387 Mon Sep 17 00:00:00 2001
From: Pavel Kopylov <pkopylov@cloudlinux.com>
Date: Wed, 17 May 2023 11:33:45 +0200
Subject: [PATCH] Fix an overflow which is still possible for some values.

Upstream-Status: Backport [https://github.com/sysstat/sysstat/commit/954ff2e2673c]
CVE: CVE-2023-33204

Backport Changes:
Adopt additional changes as per following merge commit of pull request:
https://github.com/sysstat/sysstat/commit/6f8dc568e6ab

Signed-off-by: Xiangyu Chen <xiangyu.chen@windriver.com>
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 common.c | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/common.c b/common.c
index df97bd0..0448826 100644
--- a/common.c
+++ b/common.c
@@ -1508,14 +1508,16 @@ int parse_values(char *strargv, unsigned char bitmap[], int max_val, const char
 void check_overflow(unsigned int val1, unsigned int val2,
                   unsigned int val3)
 {
-      if ((unsigned long long) val1 * (unsigned long long) val2 *
-          (unsigned long long) val3 > UINT_MAX) {
+      if ((val1 != 0) && (val2 != 0) && (val3 != 0) &&
+          (((unsigned long long) UINT_MAX / (unsigned long long) val1 <
+            (unsigned long long) val2) ||
+           ((unsigned long long) UINT_MAX / ((unsigned long long) val1 * (unsigned long long) val2) <
+            (unsigned long long) val3))) {
 #ifdef DEBUG
-              fprintf(stderr, "%s: Overflow detected (%llu). Aborting...\n",
-                      __FUNCTION__, (unsigned long long) val1 * (unsigned long long) val2 *
-                      (unsigned long long) val3);
+              fprintf(stderr, "%s: Overflow detected (%u,%u,%u)). Aborting...\n",
+                      __FUNCTION__, val1, val2, val3);
 #endif
-      exit(4);
-              }
+      	exit(4);
+        }
 }
 
-- 
2.18.2

