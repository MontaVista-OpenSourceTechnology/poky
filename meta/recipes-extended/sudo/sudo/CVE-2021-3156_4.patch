From 6ab23a7a9fe7be865e5c93363b520c704867326a Mon Sep 17 00:00:00 2001
From: "Todd C. Miller" <Todd.Miller@sudo.ws>
Date: Wed, 20 Jan 2021 09:04:12 +0100
Subject: [PATCH 4/5] Fix the memset offset when converting a v1 timestamp to
 TS_LOCKEXCL.

We want to zero the struct starting at flags, not type (which was just set).
Found by Qualys.

Upstream-Status: Backport
CVE: CVE-2021-3156 #4
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 plugins/sudoers/timestamp.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

Index: sudo-1.8.23/plugins/sudoers/timestamp.c
===================================================================
--- sudo-1.8.23.orig/plugins/sudoers/timestamp.c
+++ sudo-1.8.23/plugins/sudoers/timestamp.c
@@ -615,8 +615,8 @@ timestamp_lock(void *vcookie, struct pas
     } else if (entry.type != TS_LOCKEXCL) {
 	/* Old sudo record, convert it to TS_LOCKEXCL. */
 	entry.type = TS_LOCKEXCL;
-	memset((char *)&entry + offsetof(struct timestamp_entry, type), 0,
-	    nread - offsetof(struct timestamp_entry, type));
+	memset((char *)&entry + offsetof(struct timestamp_entry, flags), 0,
+	    nread - offsetof(struct timestamp_entry, flags));
 	if (ts_write(cookie->fd, cookie->fname, &entry, 0) == -1)
 	    debug_return_bool(false);
     }
