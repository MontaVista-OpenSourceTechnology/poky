From d530367828e3713d09489872743eb92d31fb11ff Mon Sep 17 00:00:00 2001
From: "Todd C. Miller" <Todd.Miller@sudo.ws>
Date: Tue, 1 Apr 2025 09:24:51 -0600
Subject: [PATCH] Only allow a remote host to be specified when listing
 privileges.

This fixes a bug where a user with sudoers privileges on a different
host could execute a command on the local host, even if the sudoers
file would not otherwise allow this.  CVE-2025-32462

Reported by Rich Mirch @ Stratascale Cyber Research Unit (CRU).

Upstream-Status: Backport [import from ubuntu https://git.launchpad.net/ubuntu/+source/sudo/tree/debian/patches/CVE-2025-32462.patch?h=ubuntu/jammy-security
Upstream commit https://github.com/sudo-project/sudo/commit/d530367828e3713d09489872743eb92d31fb11ff]
CVE: CVE-2025-32462
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 plugins/sudoers/sudoers.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/plugins/sudoers/sudoers.c b/plugins/sudoers/sudoers.c
index 899bda0..507f56f 100644
--- a/plugins/sudoers/sudoers.c
+++ b/plugins/sudoers/sudoers.c
@@ -298,6 +298,20 @@ sudoers_policy_main(int argc, char * const argv[], int pwflag, char *env_add[],
 	}
     }
 
+    /* The user may only specify a host for "sudo -l". */
+    if (!ISSET(sudo_mode, MODE_LIST|MODE_CHECK)) {
+	if (strcmp(user_runhost, user_host) != 0) {
+	    audit_failure(NewArgc, NewArgv,
+		N_("user not allowed to set remote host for command"));
+	    log_warningx(SLOG_NO_STDERR,
+		N_("user not allowed to set remote host for command"));
+	    sudo_warnx("%s",
+		U_("a remote host may only be specified when listing privileges."));
+	    ret = false;
+	    goto done;
+	}
+    }
+
     /* If given the -P option, set the "preserve_groups" flag. */
     if (ISSET(sudo_mode, MODE_PRESERVE_GROUPS))
 	def_preserve_groups = true;
-- 
2.24.4

