From 76e208af2ccbc98d29b4e1d24aca573a771d6d63 Mon Sep 17 00:00:00 2001
From: "Todd C. Miller" <Todd.Miller@sudo.ws>
Date: Sat, 23 Jan 2021 08:44:00 -0700
Subject: [PATCH 6/7] Fix the memset offset when converting a v1 timestamp to
 TS_LOCKEXCL. We want to zero the struct starting at flags, not type (which
 was just set). Found by Qualys.

Upstream Status: Backport https://github.com/sudo-project/sudo/commit/0754533d2445c93a380c362a185b5464c417455e
CVE: CVE-2021-3156 patch #6

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 plugins/sudoers/timestamp.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/plugins/sudoers/timestamp.c b/plugins/sudoers/timestamp.c
index f48079e..7694a5b 100644
--- a/plugins/sudoers/timestamp.c
+++ b/plugins/sudoers/timestamp.c
@@ -609,8 +609,8 @@ timestamp_lock(void *vcookie, struct passwd *pw)
 	if (entry.size == sizeof(struct timestamp_entry)) {
 	    /* Old sudo record, convert it to TS_LOCKEXCL. */
 	    entry.type = TS_LOCKEXCL;
-	    memset((char *)&entry + offsetof(struct timestamp_entry, type), 0,
-		nread - offsetof(struct timestamp_entry, type));
+	    memset((char *)&entry + offsetof(struct timestamp_entry, flags), 0,
+		nread - offsetof(struct timestamp_entry, flags));
 	    if (ts_write(cookie->fd, cookie->fname, &entry, 0) == -1)
 		debug_return_bool(false);
 	} else {
-- 
2.29.0

