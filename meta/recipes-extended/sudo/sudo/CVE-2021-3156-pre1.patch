From 5d25b4d95d72f1b87e0905f350f104a497d822ab Mon Sep 17 00:00:00 2001
From: "Todd C. Miller" <Todd.Miller@sudo.ws>
Date: Fri, 15 Dec 2017 21:08:38 -0700
Subject: [PATCH 1/7] If the lock record doesn't match the expected record size
 we need to seek to the end of the record as we otherwise may have gone too
 far (or not far enough). Fixes interop problems when the time stamp record
 changes size.

Upstream Status: Backport https://github.com/sudo-project/sudo/commit/5cec5734cc8658a78a1318135482d8de639da982
CVE: CVE-2021-3156 patch #1

Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 plugins/sudoers/timestamp.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/plugins/sudoers/timestamp.c b/plugins/sudoers/timestamp.c
index 34600f8..7e149c1 100644
--- a/plugins/sudoers/timestamp.c
+++ b/plugins/sudoers/timestamp.c
@@ -597,6 +597,14 @@ timestamp_lock(void *vcookie, struct passwd *pw)
 	if (ts_write(cookie->fd, cookie->fname, &entry, 0) == -1)
 	    debug_return_bool(false);
     }
+    if (entry.size != sizeof(entry)) {
+	/* Reset position if the lock record has an unexpected size. */
+	if (lseek(cookie->fd, entry.size, SEEK_SET) == -1) {
+	    sudo_debug_printf(SUDO_DEBUG_ERROR|SUDO_DEBUG_ERRNO|SUDO_DEBUG_LINENO,
+		"unable to seek to %lld", (long long)entry.size);
+	    debug_return_bool(false);
+	}
+    }
 
     /* Search for a tty-based record or append a new one. */
     sudo_debug_printf(SUDO_DEBUG_DEBUG|SUDO_DEBUG_LINENO,
-- 
2.29.0

