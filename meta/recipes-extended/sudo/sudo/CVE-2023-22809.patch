From 0274a4f3b403162a37a10f199c989f3727ed3ad4 Mon Sep 17 00:00:00 2001
From: "Todd C. Miller" <Todd.Miller@sudo.ws>
Date: Thu, 12 Jan 2023 15:55:27 -0700
Subject: [PATCH] sudoedit: do not permit editor arguments to include "--"
 (CVE-2023-22809) We use "--" to separate the editor and arguments from the
 files to edit. If the editor arguments include "--", sudo can be tricked into
 allowing the user to edit a file not permitted by the security policy. Thanks
 to Matthieu Barjole and Victor Cutillas of Synacktiv (https://synacktiv.com)
 for finding this bug.

Upstream-Status: Backport 
CVE: CVE-2023-22809
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 plugins/sudoers/editor.c  | 19 ++++++++++++++-----
 plugins/sudoers/sudoers.c | 25 ++++++++++++++++++-------
 plugins/sudoers/visudo.c  |  8 ++++++--
 3 files changed, 38 insertions(+), 14 deletions(-)

Index: sudo-1.8.23/plugins/sudoers/editor.c
===================================================================
--- sudo-1.8.23.orig/plugins/sudoers/editor.c
+++ sudo-1.8.23/plugins/sudoers/editor.c
@@ -125,7 +125,7 @@ resolve_editor(const char *ed, size_t ed
     const char *cp, *ep, *tmp;
     const char *edend = ed + edlen;
     struct stat user_editor_sb;
-    int nargc;
+    int nargc = 0;
     debug_decl(resolve_editor, SUDOERS_DEBUG_UTIL)
 
     /*
@@ -142,9 +142,7 @@ resolve_editor(const char *ed, size_t ed
 
     /* If we can't find the editor in the user's PATH, give up. */
     if (find_path(editor, &editor_path, &user_editor_sb, getenv("PATH"), 0, whitelist) != FOUND) {
-	free(editor);
-	errno = ENOENT;
-	debug_return_str(NULL);
+    goto bad;
     }
 
     /* Count rest of arguments and allocate editor argv. */
@@ -164,6 +162,17 @@ resolve_editor(const char *ed, size_t ed
 	nargv[nargc] = copy_arg(cp, ep - cp);
 	if (nargv[nargc] == NULL)
 	    goto oom;
+
+	/*
+	 * We use "--" to separate the editor and arguments from the files
+	 * to edit.  The editor arguments themselves may not contain "--".
+	 */
+	if (strcmp(nargv[nargc], "--") == 0) {
+	    sudo_warnx(U_("ignoring editor: %.*s"), (int)edlen, ed);
+	    sudo_warnx("%s", U_("editor arguments may not contain \"--\""));
+	    errno = EINVAL;
+	    goto bad;
+	}
     }
     if (nfiles != 0) {
 	nargv[nargc++] = "--";
@@ -177,6 +186,7 @@ resolve_editor(const char *ed, size_t ed
     debug_return_str(editor_path);
 oom:
     sudo_warnx(U_("%s: %s"), __func__, U_("unable to allocate memory"));
+bad:
     free(editor);
     free(editor_path);
     if (nargv != NULL) {
Index: sudo-1.8.23/plugins/sudoers/visudo.c
===================================================================
--- sudo-1.8.23.orig/plugins/sudoers/visudo.c
+++ sudo-1.8.23/plugins/sudoers/visudo.c
@@ -287,7 +287,7 @@ static char *
 get_editor(int *editor_argc, char ***editor_argv)
 {
     char *editor_path = NULL, **whitelist = NULL;
-    const char *env_editor;
+    const char *env_editor = NULL;
     static char *files[] = { "+1", "sudoers" };
     unsigned int whitelist_len = 0;
     debug_decl(get_editor, SUDOERS_DEBUG_UTIL)
@@ -321,7 +321,11 @@ get_editor(int *editor_argc, char ***edi
     if (editor_path == NULL) {
 	if (def_env_editor && env_editor != NULL) {
 	    /* We are honoring $EDITOR so this is a fatal error. */
-	    sudo_fatalx(U_("specified editor (%s) doesn't exist"), env_editor);
+	    if (errno == ENOENT) {
+		sudo_warnx(U_("specified editor (%s) doesn't exist"),
+		    env_editor);
+	    }
+	    exit(EXIT_FAILURE);
 	}
 	sudo_fatalx(U_("no editor found (editor path = %s)"), def_editor);
     }
