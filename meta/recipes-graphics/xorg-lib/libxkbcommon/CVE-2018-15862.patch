From e395f189e79d8727e5e10bc0f87488df54d2fcfc Mon Sep 17 00:00:00 2001
From: Daniel Stone <daniels@collabora.com>
Date: Mon, 26 Jun 2017 17:18:16 +0100
Subject: [PATCH] xkbcomp: Don't explode on invalid virtual modifiers

testcase: 'virtualModifiers=LevelThreC'

Upstream-Status: Backport (https://github.com/xkbcommon/libxkbcommon/commit/4e2ee9c3f6050d773f8bbe05bc0edb17f1ff8371)
CVE: CVE-2018-15862

Signed-off-by: Daniel Stone <daniels@collabora.com>
Signed-off-by: Rahul Chauhan <rahulk@mvista.com>
---
 src/xkbcomp/expr.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/xkbcomp/expr.c b/src/xkbcomp/expr.c
index c491c9f..1b61ae5 100644
--- a/src/xkbcomp/expr.c
+++ b/src/xkbcomp/expr.c
@@ -105,6 +105,8 @@ LookupModMask(struct xkb_context *ctx, const void *priv, xkb_atom_t field,
         return false;

     str = xkb_atom_text(ctx, field);
+    if (!str)
+        return false;

     if (istreq(str, "all")) {
         *val_rtrn  = MOD_REAL_MASK_ALL;
--
2.7.4
