From 398c1e9acc9b4531edceb3d77da0de5744675052 Mon Sep 17 00:00:00 2001
From: Darrell Walisser <darrell.walisser@gmail.com>
Date: Sat, 16 Jun 2018 18:31:35 -0400
Subject: [PATCH] Fix jpeg_skip_scanlines() segfault w/merged upsamp

Fixes NULL pointer reference when decompressing 4:2:2 or 4:2:0 JPEG
images with cinfo.do_fancy_upsampling = FALSE.

Closes #244

Upstream-Status: Backport [https://launchpad.net/ubuntu/+archive/primary/+sourcefiles/libjpeg-turbo/1.5.2-0ubuntu5.18.04.6/libjpeg-turbo_1.5.2-0ubuntu5.18.04.6.debian.tar.xz
Upstream-Commit: https://github.com/libjpeg-turbo/libjpeg-turbo/commit/398c1e9acc9b4531edceb3d77da0de5744675052
CVE: CVE-2020-35538 #Dependency patch1
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 ChangeLog.md |  4 ++++
 jdapistd.c   | 13 +++++++++----
 2 files changed, 13 insertions(+), 4 deletions(-)

#diff --git a/ChangeLog.md b/ChangeLog.md
#index f64866ed1..e18a2826b 100644
#--- a/ChangeLog.md
#+++ b/ChangeLog.md
#@@ -40,6 +40,10 @@ when attempting to load the BMP file into a 4-component image buffer.
# loop when decompressing progressive JPEG images that use vertical chroma
# subsampling (for instance, 4:2:0 or 4:4:0.)
# 
#+6. Fixed a segfault in `jpeg_skip_scanlines()` that occurred when decompressing
#+a 4:2:2 or 4:2:0 JPEG image using the merged (non-fancy) upsampling algorithms
#+(that is, when setting `cinfo.do_fancy_upsampling` to `FALSE`.)
#+
# 
# 1.5.90 (2.0 beta1)
# ==================
--- a/jdapistd.c
+++ b/jdapistd.c
@@ -315,12 +315,15 @@ read_and_discard_scanlines (j_decompress
   JDIMENSION n;
   void (*color_convert) (j_decompress_ptr cinfo, JSAMPIMAGE input_buf,
                          JDIMENSION input_row, JSAMPARRAY output_buf,
-                         int num_rows);
+                         int num_rows) = NULL;
   void (*color_quantize) (j_decompress_ptr cinfo, JSAMPARRAY input_buf,
                           JSAMPARRAY output_buf, int num_rows) = NULL;
 
-  color_convert = cinfo->cconvert->color_convert;
-  cinfo->cconvert->color_convert = noop_convert;
+  if (cinfo->cconvert && cinfo->cconvert->color_convert) {
+    color_convert = cinfo->cconvert->color_convert;
+    cinfo->cconvert->color_convert = noop_convert;
+  }
+
   if (cinfo->cquantize && cinfo->cquantize->color_quantize) {
     color_quantize = cinfo->cquantize->color_quantize;
     cinfo->cquantize->color_quantize = noop_quantize;
@@ -329,7 +332,9 @@ read_and_discard_scanlines (j_decompress
   for (n = 0; n < num_lines; n++)
     jpeg_read_scanlines(cinfo, NULL, 1);
 
-  cinfo->cconvert->color_convert = color_convert;
+  if (color_convert)
+    cinfo->cconvert->color_convert = color_convert;
+
   if (color_quantize)
     cinfo->cquantize->color_quantize = color_quantize;
 }
