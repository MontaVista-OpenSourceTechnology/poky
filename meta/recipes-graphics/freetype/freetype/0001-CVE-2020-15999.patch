From 008412a0be05db716caeb35ce3d01dd955d3f4a0 Mon Sep 17 00:00:00 2001
From: Vijay Anusuri <vanusuri@mvista.com>
Date: Fri, 29 Jul 2022 07:21:49 +0000
Subject: [PATCH] CVE-2020-15999

[sfnt] Fix heap buffer overflow (#59308).

* src/sfnt/pngshim.c (Load_SBit_Png): Test bitmap size earlier.

Upstream-Status: Backport from https://git.savannah.gnu.org/cgit/freetype/freetype2.git/commit/?id=a3bab162b2ae616074c8877a04556932998aeacd
CVE: CVE-2020-15999
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 ChangeLog          |  8 ++++++++
 src/sfnt/pngshim.c | 14 +++++++-------
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index b81af15..2449bb6 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,11 @@
+2020-10-19  Werner Lemberg  <wl@gnu.org>
+
+	[sfnt] Fix heap buffer overflow (#59308).
+
+	This is CVE-2020-15999.
+
+	* src/sfnt/pngshim.c (Load_SBit_Png): Test bitmap size earlier.
+
 2017-05-13  Werner Lemberg  <wl@gnu.org>
 
 	* Version 2.8 released.
diff --git a/src/sfnt/pngshim.c b/src/sfnt/pngshim.c
index b9b296e..6a82a62 100644
--- a/src/sfnt/pngshim.c
+++ b/src/sfnt/pngshim.c
@@ -260,6 +260,13 @@
 
     if ( populate_map_and_metrics )
     {
+      /* reject too large bitmaps similarly to the rasterizer */
+      if ( imgHeight > 0x7FFF || imgWidth > 0x7FFF )
+      {
+        error = FT_THROW( Array_Too_Large );
+        goto DestroyExit;
+      }
+
       metrics->width  = (FT_UShort)imgWidth;
       metrics->height = (FT_UShort)imgHeight;
 
@@ -268,13 +275,6 @@
       map->pixel_mode = FT_PIXEL_MODE_BGRA;
       map->pitch      = (int)( map->width * 4 );
       map->num_grays  = 256;
-
-      /* reject too large bitmaps similarly to the rasterizer */
-      if ( map->rows > 0x7FFF || map->width > 0x7FFF )
-      {
-        error = FT_THROW( Array_Too_Large );
-        goto DestroyExit;
-      }
     }
 
     /* convert palette/gray image to rgb */
-- 
2.18.2

