From a94fd6956367085e0257e7ee79a01cca557802f1 Mon Sep 17 00:00:00 2001
From: Hitendra Prajapati <hprajapati@mvista.com>
Date: Mon, 28 Mar 2022 13:42:27 +0530
Subject: [PATCH] CVE-2021-46143

Upstream-Status: Backport from https://github.com/libexpat/libexpat/pull/538/commits/85ae9a2d7d0e9358f356b33977b842df8ebaec2b

Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 lib/xmlparse.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index ad6695d..83fb673 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -5020,13 +5020,28 @@ doProlog(XML_Parser parser,
     case XML_ROLE_GROUP_OPEN:
       if (prologState.level >= groupSize) {
         if (groupSize) {
+        /* Detect and prevent integer overflow */
+            if (parser->m_groupSize > (unsigned int)(-1) / 2u) {
+              return XML_ERROR_NO_MEMORY;
+            }
+
           char *temp = (char *)REALLOC(groupConnector, groupSize *= 2);
           if (temp == NULL) {
             groupSize /= 2;
             return XML_ERROR_NO_MEMORY;
           }
           groupConnector = temp;
+
           if (dtd->scaffIndex) {
+          /* Detect and prevent integer overflow.
+             * The preprocessor guard addresses the "always false" warning
+             * from -Wtype-limits on platforms where
+             * sizeof(unsigned int) < sizeof(size_t), e.g. on x86_64. */
+#if UINT_MAX >= SIZE_MAX
+            if (parser->m_groupSize > (size_t)(-1) / sizeof(int)) {
+              return XML_ERROR_NO_MEMORY;
+            }
+#endif
             int *temp = (int *)REALLOC(dtd->scaffIndex,
                           groupSize * sizeof(int));
             if (temp == NULL)
-- 
2.25.1

