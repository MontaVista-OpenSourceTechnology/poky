From: Sebastian Pipping <sebastian@pipping.org>
Date: Sat, 12 Feb 2022 01:09:29 +0100
Subject: lib: Protect against malicious namespace declarations
 (CVE-2022-25236)
Origin: https://github.com/libexpat/libexpat/commit/a2fe525e660badd64b6c557c2b1ec26ddc07f6e4
Bug: https://github.com/libexpat/libexpat/pull/561
Bug-Debian: https://bugs.debian.org/1005895
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2022-25236

Upstream-Status: Backport
CVE: CVE-2022-25236 #1
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 lib/xmlparse.c | 11 +++++++++++
 1 file changed, 11 insertions(+)

Index: expat-2.2.6/lib/xmlparse.c
===================================================================
--- expat-2.2.6.orig/lib/xmlparse.c
+++ expat-2.2.6/lib/xmlparse.c
@@ -3699,6 +3699,17 @@ addBinding(XML_Parser parser, PREFIX *pr
     if (!mustBeXML && isXMLNS
         && (len > xmlnsLen || uri[len] != xmlnsNamespace[len]))
       isXMLNS = XML_FALSE;
+
+    // NOTE: While Expat does not validate namespace URIs against RFC 3986,
+    //       we have to at least make sure that the XML processor on top of
+    //       Expat (that is splitting tag names by namespace separator into
+    //       2- or 3-tuples (uri-local or uri-local-prefix)) cannot be confused
+    //       by an attacker putting additional namespace separator characters
+    //       into namespace declarations.  That would be ambiguous and not to
+    //       be expected.
+    if (parser->m_ns && (uri[len] == parser->m_namespaceSeparator)) {
+      return XML_ERROR_SYNTAX;
+    }
   }
   isXML = isXML && len == xmlLen;
   isXMLNS = isXMLNS && len == xmlnsLen;
