From c88256d51da36155370da79c08303e2e56eaa1e9 Mon Sep 17 00:00:00 2001
From: Rohini Sangam <rsangam@mvista.com>
Date: Mon, 9 Sep 2024 10:03:54 +0000
Subject: [PATCH] CVE-2024-45491: Detect integer overflow in 'dtdCopy'

Upstream-Status: Backport from https://github.com/libexpat/libexpat/commit/b8a7dca4670973347892cfc452b24d9001dcd6f5
CVE: CVE-2024-45491

Signed-off-by: Rohini Sangam <rsangam@mvista.com>
---
 expat/lib/xmlparse.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index e9ffe3f7..f824f7b6 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -6704,6 +6704,16 @@ dtdCopy(XML_Parser oldParser, DTD *newDtd, const DTD *oldDtd,
     if (! newE)
       return 0;
     if (oldE->nDefaultAtts) {
+      /* Detect and prevent integer overflow.
+       * The preprocessor guard addresses the "always false" warning
+       * from -Wtype-limits on platforms where
+       * sizeof(int) < sizeof(size_t), e.g. on x86_64. */
+#if UINT_MAX >= SIZE_MAX
+      if ((size_t)oldE->nDefaultAtts
+          > ((size_t)(-1) / sizeof(DEFAULT_ATTRIBUTE))) {
+        return 0;
+      }
+#endif
       newE->defaultAtts = (DEFAULT_ATTRIBUTE *)ms->malloc_fcn(
           oldE->nDefaultAtts * sizeof(DEFAULT_ATTRIBUTE));
       if (! newE->defaultAtts) {
-- 
2.24.4

