From b8e562a2b4912a727813e8f4848bba4b393aa9c6 Mon Sep 17 00:00:00 2001
From: vivek kumbhar <vkumbhar@mvista.com>
Date: Thu, 24 Mar 2022 04:45:06 +0000
Subject: [PATCH] CVE-2022-23990 expat

---
 Changes        |  7 +++++++
 lib/xmlparse.c | 10 ++++++++--
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/Changes b/Changes
index b0ee42c..9b44266 100644
--- a/Changes
+++ b/Changes
@@ -32,9 +32,16 @@ Release 2.2.6 Sun August 12 2018
   #131 #173 #202  Address compiler warnings
   #187 #190 #200  Fix miscellaneous typos
                   Version info bumped from 7:7:6 to 7:8:6
+                  
+       #551  CVE-2022-23990 -- Fix unsigned integer overflow in function
+       doProlog triggered by large content in element type
+       declarations when there is an element declaration handler
+       present (from a prior call to XML_SetElementDeclHandler).
+       Impact is denial of service or more.
 
         Special thanks to:
             Anton Maklakov
+            Roland Illig
             Benjamin Peterson
             Brad King
             Franek Korta
diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index 85b670e..1844712 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -5211,7 +5211,7 @@ doProlog(XML_Parser parser,
       if (dtd->in_eldecl) {
         ELEMENT_TYPE *el;
         const XML_Char *name;
-        int nameLen;
+        size_t nameLen;
         const char *nxt = (quant == XML_CQUANT_NONE
                            ? next
                            : next - enc->minBytesPerChar);
@@ -5227,7 +5227,13 @@ doProlog(XML_Parser parser,
         dtd->scaffold[myindex].name = name;
         nameLen = 0;
         for (; name[nameLen++]; );
-        dtd->contentStringLen +=  nameLen;
+
+ 	/* Detect and prevent integer overflow */
+        if (nameLen > UINT_MAX - dtd->contentStringLen) {
+          return XML_ERROR_NO_MEMORY;
+        }
+
+        dtd->contentStringLen += (unsigned)nameLen;
         if (parser->m_elementDeclHandler)
           handleDefault = XML_FALSE;
       }
-- 
2.18.2

