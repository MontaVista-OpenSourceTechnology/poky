From: Samanta Navarro <ferivoz@riseup.net>
Date: Sat, 22 Jan 2022 17:48:00 +0100
Subject: lib: Detect and prevent integer overflow in XML_GetBuffer
 (CVE-2022-23852)
Origin: https://github.com/libexpat/libexpat/commit/847a645152f5ebc10ac63b74b604d0c1a79fae40
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2022-23852

[Salvatore Bonaccorso: Backport to 2.2.6: Update for context changes]

Upstream-Status: Backport
CVE: CVE-2022-23852
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 expat/lib/xmlparse.c | 5 +++++
 1 file changed, 5 insertions(+)

--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -2047,6 +2047,11 @@ XML_GetBuffer(XML_Parser parser, int len
     keep = (int)EXPAT_SAFE_PTR_DIFF(parser->m_bufferPtr, parser->m_buffer);
     if (keep > XML_CONTEXT_BYTES)
       keep = XML_CONTEXT_BYTES;
+    /* Detect and prevent integer overflow */
+    if (keep > INT_MAX - neededSize) {
+      parser->m_errorCode = XML_ERROR_NO_MEMORY;
+      return NULL;
+    }
     neededSize += keep;
 #endif  /* defined XML_CONTEXT_BYTES */
     if (neededSize <= EXPAT_SAFE_PTR_DIFF(parser->m_bufferLim, parser->m_buffer)) {
