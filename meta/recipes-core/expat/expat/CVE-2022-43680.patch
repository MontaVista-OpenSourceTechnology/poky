From 5290462a7ea1278a8d5c0d5b2860d4e244f997e4 Mon Sep 17 00:00:00 2001
From: Sebastian Pipping <sebastian@pipping.org>
Date: Tue, 20 Sep 2022 02:44:34 +0200
Subject: [PATCH] lib: Fix overeager DTD destruction in
 XML_ExternalEntityParserCreate

Upstream-Status: Backport
CVE: CVE-2022-43680
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 lib/xmlparse.c | 8 ++++++++
 1 file changed, 8 insertions(+)

Index: expat-2.2.6/lib/xmlparse.c
===================================================================
--- expat-2.2.6.orig/lib/xmlparse.c
+++ expat-2.2.6/lib/xmlparse.c
@@ -1017,6 +1017,14 @@ parserCreate(const XML_Char *encodingNam
   parserInit(parser, encodingName);
 
   if (encodingName && !parser->m_protocolEncodingName) {
+     if (dtd) {
+        // We need to stop the upcoming call to XML_ParserFree from happily
+        // destroying parser->m_dtd because the DTD is shared with the parent
+        // parser and the only guard that keeps XML_ParserFree from destroying
+        // parser->m_dtd is parser->m_isParamEntity but it will be set to
+        // XML_TRUE only later in XML_ExternalEntityParserCreate (or not at all).
+        parser->m_dtd = NULL;
+    }
     XML_ParserFree(parser);
     return NULL;
   }
