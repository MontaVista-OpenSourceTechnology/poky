From e237603e6b6de1b68916cb9649bedf6a5eaeaa28 Mon Sep 17 00:00:00 2001
From: Rohini Sangam <rsangam@mvista.com>
Date: Mon, 9 Sep 2024 10:07:04 +0000
Subject: [PATCH] CVE-2024-45492: Detect integer overflow in function 'nextScaffoldPart'

Upstream-Status: Backport from https://github.com/libexpat/libexpat/commit/29ef43a0bab633b41e71dd6d900fff5f6b3ad5e4
CVE: CVE-2024-45492

Signed-off-by: Rohini Sangam <rsangam@mvista.com>
---
 expat/lib/xmlparse.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/lib/xmlparse.c b/lib/xmlparse.c
index f824f7b6..934ab654 100644
--- a/lib/xmlparse.c
+++ b/lib/xmlparse.c
@@ -7256,6 +7256,15 @@ nextScaffoldPart(XML_Parser parser) {
   int next;
 
   if (! dtd->scaffIndex) {
+    /* Detect and prevent integer overflow.
+     * The preprocessor guard addresses the "always false" warning
+     * from -Wtype-limits on platforms where
+     * sizeof(unsigned int) < sizeof(size_t), e.g. on x86_64. */
+#if UINT_MAX >= SIZE_MAX
+    if (parser->m_groupSize > ((size_t)(-1) / sizeof(int))) {
+      return -1;
+    }
+#endif
     dtd->scaffIndex = (int *)MALLOC(parser, parser->m_groupSize * sizeof(int));
     if (! dtd->scaffIndex)
       return -1;
-- 
2.24.4

