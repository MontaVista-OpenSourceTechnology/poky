From 615c1467c81411bf1d19fd7092e8995b5ebadc13 Mon Sep 17 00:00:00 2001
From: Tom Gundersen <teg@jklm.no>
Date: Fri, 16 May 2014 00:50:44 +0200
Subject: [PATCH] sd-dhcp-client: add support for FORCERENEW

This partially implements RFC3203. Note that we are not fully compliant as we do not
support authentication.

Upstream-Status: Backport
CVE:CVE-2020-13529
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 src/libsystemd-network/sd-dhcp-client.c | 44 ++++++++++++++++++++-----
 2 files changed, 37 insertions(+), 9 deletions(-)

Index: git/src/libsystemd-network/sd-dhcp-client.c
===================================================================
--- git.orig/src/libsystemd-network/sd-dhcp-client.c
+++ git/src/libsystemd-network/sd-dhcp-client.c
@@ -1773,6 +1772,16 @@ static int client_receive_message_udp(
                                 be32toh(message->xid), client->xid);
                 return 0;
         }
+
+        if (client->state != DHCP_STATE_BOUND &&
+            be32toh(message->xid) != client->xid) {
+                /* in BOUND state, we may receive FORCERENEW with xid set by server,
+                   so ignore the xid in this case */
+                log_dhcp_client(client, "received xid (%u) does not match "
+                                "expected (%u): ignoring",
+                                be32toh(message->xid), client->xid);
+                return 0;
+        }
 
         return client_handle_message(client, message, len);
 }
