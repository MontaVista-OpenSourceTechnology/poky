From 72d4c15a946d20143cd4c6783c802124bc894dc7 Mon Sep 17 00:00:00 2001
From: Yu Watanabe <watanabe.yu+github@gmail.com>
Date: Thu, 7 Jul 2022 18:27:02 +0900
Subject: [PATCH] time-util: fix buffer-over-run

Fixes #23928.

(cherry picked from commit 9102c625a673a3246d7e73d8737f3494446bad4e)

Upstream-Status: Backport
CVE: CVE-2022-3821
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 src/basic/time-util.c     | 2 +-
 src/test/test-time-util.c | 5 +++++
 2 files changed, 6 insertions(+), 1 deletion(-)

Index: git/src/basic/time-util.c
===================================================================
--- git.orig/src/basic/time-util.c
+++ git/src/basic/time-util.c
@@ -515,7 +515,7 @@ char *format_timespan(char *buf, size_t
                         t = b;
                 }
 
-                n = MIN((size_t) k, l);
+                n = MIN((size_t) k, l-1);
 
                 l -= n;
                 p += n;
Index: git/src/test/test-time-util.c
===================================================================
--- git.orig/src/test/test-time-util.c
+++ git/src/test/test-time-util.c
@@ -167,6 +167,11 @@ static void test_format_timespan(usec_t
         test_format_timespan_one(500 * USEC_PER_MSEC, accuracy);
         test_format_timespan_one(9*USEC_PER_YEAR/5 - 23, accuracy);
         test_format_timespan_one(USEC_INFINITY, accuracy);
+
+        /* See issue #23928. */
+        _cleanup_free_ char *buf;
+        assert_se(buf = new(char, 5));
+        assert_se(buf == format_timespan(buf, 5, 100005, 1000));
 }
 
 static void test_timezone_is_valid(void) {
