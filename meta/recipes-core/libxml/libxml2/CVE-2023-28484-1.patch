From 4c6922f763ad958c48ff66f82823ae21f2e92ee6 Mon Sep 17 00:00:00 2001
From: Nick Wellnhofer <wellnhofer@aevum.de>
Date: Tue, 13 Sep 2022 16:40:31 +0200
Subject: [PATCH] schemas: Fix null-pointer-deref in
 xmlSchemaCheckCOSSTDerivedOK

Found by OSS-Fuzz.

Upstream-Status: Backport [import from ubuntu https://git.launchpad.net/ubuntu/+source/libxml2/tree/debian/patches/CVE-2023-28484-1.patch?h=ubuntu/bionic-security
Upstream commit https://gitlab.gnome.org/GNOME/libxml2/-/commit/4c6922f763ad958c48ff66f82823ae21f2e92ee6]
CVE: CVE-2023-28484
Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
---
 result/schemas/oss-fuzz-51295_0_0.err |  2 ++
 test/schemas/oss-fuzz-51295_0.xml     |  1 +
 test/schemas/oss-fuzz-51295_0.xsd     |  4 ++++
 xmlschemas.c                          | 15 +++++++++++++--
 4 files changed, 20 insertions(+), 2 deletions(-)
 create mode 100644 result/schemas/oss-fuzz-51295_0_0.err
 create mode 100644 test/schemas/oss-fuzz-51295_0.xml
 create mode 100644 test/schemas/oss-fuzz-51295_0.xsd

Index: libxml2-2.9.4+dfsg1/result/schemas/oss-fuzz-51295_0_0.err
===================================================================
--- /dev/null
+++ libxml2-2.9.4+dfsg1/result/schemas/oss-fuzz-51295_0_0.err
@@ -0,0 +1,2 @@
+./test/schemas/oss-fuzz-51295_0.xsd:2: element element: Schemas parser error : element decl. 'e': The element declaration 'e' defines a circular substitution group to element declaration 'e'.
+./test/schemas/oss-fuzz-51295_0.xsd:2: element element: Schemas parser error : element decl. 'e': The element declaration 'e' defines a circular substitution group to element declaration 'e'.
Index: libxml2-2.9.4+dfsg1/test/schemas/oss-fuzz-51295_0.xml
===================================================================
--- /dev/null
+++ libxml2-2.9.4+dfsg1/test/schemas/oss-fuzz-51295_0.xml
@@ -0,0 +1 @@
+<e/>
Index: libxml2-2.9.4+dfsg1/test/schemas/oss-fuzz-51295_0.xsd
===================================================================
--- /dev/null
+++ libxml2-2.9.4+dfsg1/test/schemas/oss-fuzz-51295_0.xsd
@@ -0,0 +1,4 @@
+<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">
+    <xs:element name="e" substitutionGroup="e"/>
+    <xs:element name="t" substitutionGroup="e" type='xs:decimal'/>
+</xs:schema>
Index: libxml2-2.9.4+dfsg1/xmlschemas.c
===================================================================
--- libxml2-2.9.4+dfsg1.orig/xmlschemas.c
+++ libxml2-2.9.4+dfsg1/xmlschemas.c
@@ -13268,8 +13268,19 @@ xmlSchemaResolveElementReferences(xmlSch
 	    * declaration `resolved` to by the `actual value`
 	    * of the substitutionGroup [attribute], if present"
 	    */
-	    if (elemDecl->subtypes == NULL)
-		elemDecl->subtypes = substHead->subtypes;
+	    if (elemDecl->subtypes == NULL) {
+                if (substHead->subtypes == NULL) {
+                    /*
+                     * This can happen with self-referencing substitution
+                     * groups. The cycle will be detected later, but we have
+                     * to set subtypes to avoid null-pointer dereferences.
+                     */
+	            elemDecl->subtypes = xmlSchemaGetBuiltInType(
+                            XML_SCHEMAS_ANYTYPE);
+                } else {
+		    elemDecl->subtypes = substHead->subtypes;
+                }
+            }
 	}
     }
     /*
