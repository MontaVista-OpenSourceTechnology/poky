From ff9e04ad457280c24036153431f2e8ced2d18556 Mon Sep 17 00:00:00 2001
From: Simon McVittie <smcv@collabora.com>
Date: Wed, 23 Jan 2019 12:09:27 +0000
Subject: [PATCH 2/4] _dbus_user_database_get_groupname: Inline into its only
 caller

Signed-off-by: Simon McVittie <smcv@collabora.com>

Upstream-Status: Backport [https://gitlab.freedesktop.org/dbus/dbus/-/commit/2091cd73b14e203188c34d26ca9b80a97a3ea66f]
CVE: CVE-2020-35512 #dep-2
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 dbus/dbus-userdb-util.c | 27 ++++-----------------------
 dbus/dbus-userdb.h      |  5 -----
 2 files changed, 4 insertions(+), 28 deletions(-)

diff --git a/dbus/dbus-userdb-util.c b/dbus/dbus-userdb-util.c
index 8948778..a67ccb4 100644
--- a/dbus/dbus-userdb-util.c
+++ b/dbus/dbus-userdb-util.c
@@ -174,8 +174,10 @@ _dbus_get_group_id (const DBusString  *groupname,
       return FALSE;
     }
 
-  if (!_dbus_user_database_get_groupname (db, groupname,
-                                          &info, NULL))
+  info = _dbus_user_database_lookup_group (db, DBUS_GID_UNSET, groupname,
+                                           NULL);
+
+  if (info == NULL)
     {
       _dbus_user_database_unlock_system ();
       return FALSE;
@@ -332,27 +334,6 @@ _dbus_user_database_lookup_group (DBusUserDatabase *db,
     }
 }
 
-
-/**
- * Gets the user information for the given group name,
- * returned group info should not be freed. 
- *
- * @param db user database
- * @param groupname the group name
- * @param info return location for const ref to group info
- * @param error error location
- * @returns #FALSE if error is set
- */
-dbus_bool_t
-_dbus_user_database_get_groupname (DBusUserDatabase     *db,
-                                   const DBusString     *groupname,
-                                   const DBusGroupInfo **info,
-                                   DBusError            *error)
-{
-  *info = _dbus_user_database_lookup_group (db, DBUS_GID_UNSET, groupname, error);
-  return *info != NULL;
-}
-
 /**
  * Gets all groups  corresponding to the given UID. Returns #FALSE
  * if no memory, or user isn't known, but always initializes
diff --git a/dbus/dbus-userdb.h b/dbus/dbus-userdb.h
index 38ce5c1..c5ecf22 100644
--- a/dbus/dbus-userdb.h
+++ b/dbus/dbus-userdb.h
@@ -66,11 +66,6 @@ dbus_bool_t       _dbus_user_database_get_username  (DBusUserDatabase     *db,
                                                      const DBusString     *username,
                                                      const DBusUserInfo  **info,
                                                      DBusError            *error);
-dbus_bool_t       _dbus_user_database_get_groupname (DBusUserDatabase     *db,
-                                                     const DBusString     *groupname,
-                                                     const DBusGroupInfo **info,
-                                                     DBusError            *error);
-
 DBUS_PRIVATE_EXPORT
 DBusUserInfo*  _dbus_user_database_lookup       (DBusUserDatabase *db,
                                                  dbus_uid_t        uid,
-- 
2.7.4

