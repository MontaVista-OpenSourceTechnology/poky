From 820cede2543af1825a53c0512ed7300a22db9a5b Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Fri, 17 Jun 2022 17:45:34 +0200
Subject: [PATCH 2/2] awk: fix use after free (CVE-2022-30065)

fixes https://bugs.busybox.net/show_bug.cgi?id=14781

function                                             old     new   delta
evaluate                                            3343    3357     +14

Signed-off-by: Natanael Copa <ncopa@alpinelinux.org>
Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>

Upstream-Status: Backport [https://git.busybox.net/busybox/commit/?id=e63d7cdfdac78c6fd27e9e63150335767592b85e]
CVE: CVE-2022-30065
Signed-off-by: E V Ravi <reluri@mvista.com>
---
 editors/awk.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/editors/awk.c b/editors/awk.c
index 94fc1d3..d117622 100644
--- a/editors/awk.c
+++ b/editors/awk.c
@@ -2761,6 +2761,9 @@ static var *evaluate(node *op, var *res)
 
 		case XC( OC_MOVE ):
 			debug_printf_eval("MOVE\n");
+			/* make sure that we never return a temp var */
+			if (L.v == TMPVAR0)
+				L.v = res;
 			/* if source is a temporary string, jusk relink it to dest */
 //Disabled: if R.v is numeric but happens to have cached R.v->string,
 //then L.v ends up being a string, which is wrong
-- 
2.7.4

