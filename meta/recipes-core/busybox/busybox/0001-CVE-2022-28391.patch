From 82a77bee18ed7e6109eba48054d819d328eac978 Mon Sep 17 00:00:00 2001
From: Ariadne Conill <ariadne@dereferenced.org>
Date: Sun, 3 Apr 2022 12:14:33 +0000
Subject: [PATCH 1/2] libbb: sockaddr2str: ensure only printable characters are
 returned for the hostname part

Signed-off-by: Ariadne Conill <ariadne@dereferenced.org>

Upstream-Status: Backport [https://git.alpinelinux.org/aports/plain/main/busybox/0001-libbb-sockaddr2str-ensure-only-printable-characters-.patch]
CVE: CVE-2022-28391
Signed-off-by: Shubham Kulkarni <skulkarni@mvista.com>
---
 libbb/xconnect.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/libbb/xconnect.c b/libbb/xconnect.c
index 39e56b2..5d6ce73 100644
--- a/libbb/xconnect.c
+++ b/libbb/xconnect.c
@@ -465,8 +465,9 @@ static char* FAST_FUNC sockaddr2str(const struct sockaddr *sa, int flags)
	);
	if (rc)
		return NULL;
+	/* ensure host contains only printable characters */
	if (flags & IGNORE_PORT)
-		return xstrdup(host);
+		return xstrdup(printable_string(NULL, host));
 #if ENABLE_FEATURE_IPV6
	if (sa->sa_family == AF_INET6) {
		if (strchr(host, ':')) /* heh, it's not a resolved hostname */
@@ -477,7 +478,7 @@ static char* FAST_FUNC sockaddr2str(const struct sockaddr *sa, int flags)
 #endif
	/* For now we don't support anything else, so it has to be INET */
	/*if (sa->sa_family == AF_INET)*/
-		return xasprintf("%s:%s", host, serv);
+		return xasprintf("%s:%s", printable_string(NULL, host), serv);
	/*return xstrdup(host);*/
 }

--
2.7.4
