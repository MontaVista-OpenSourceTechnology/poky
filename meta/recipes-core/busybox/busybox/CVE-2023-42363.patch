From fb08d43d44d1fea1f741fafb9aa7e1958a5f69aa Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 20 May 2024 17:55:28 +0200
Subject: awk: fix use after free (CVE-2023-42363)

function                                             old     new   delta
evaluate                                            3377    3385      +8

Fixes https://bugs.busybox.net/show_bug.cgi?id=15865

Signed-off-by: Natanael Copa <ncopa@alpinelinux.org>
Signed-off-by: Denys Vlasenko <vda.linux@googlemail.com>

Upstream-Status: Backport [https://git.busybox.net/busybox/commit/?id=fb08d43d44d1fea1f741fafb9aa7e1958a5f69aa]
CVE: CVE-2023-42363
Signed-off-by: Hitendra Prajapati <hprajapati@mvista.com>
---
 editors/awk.c | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/editors/awk.c b/editors/awk.c
index 4e4f282..ce76a68 100644
--- a/editors/awk.c
+++ b/editors/awk.c
@@ -2609,10 +2609,6 @@ static var *evaluate(node *op, var *res)
 			L.v = evaluate(op1, v1);
 		if (opinfo & OF_RES2)
 			R.v = evaluate(op->r.n, v1+1);
-		if (opinfo & OF_STR1) {
-			L.s = getvar_s(L.v);
-			debug_printf_eval("L.s:'%s'\n", L.s);
-		}
 		if (opinfo & OF_STR2) {
 			R.s = getvar_s(R.v);
 			debug_printf_eval("R.s:'%s'\n", R.s);
@@ -2622,6 +2618,16 @@ static var *evaluate(node *op, var *res)
 			debug_printf_eval("L_d:%f\n", L_d);
 		}
 
+		/* Get L.s _after_ R.v is evaluated: it may have realloc'd L.v
+		 * so we must get the string after "old_Fields_ptr" correction
+		 * above. Testcase: x = (v = "abc", gsub("b", "X", v));
+		 */
+		if (opinfo & OF_RES1) {
+			if (opinfo & OF_STR1) {
+				L.s = getvar_s(L.v);
+				debug_printf_eval("L.s:'%s'\n", L.s);
+			}
+		}
 		debug_printf_eval("switch(0x%x)\n", XC(opinfo & OPCLSMASK));
 		switch (XC(opinfo & OPCLSMASK)) {
 
-- 
2.25.1

