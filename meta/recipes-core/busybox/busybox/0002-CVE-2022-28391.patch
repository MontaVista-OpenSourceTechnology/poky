From bebd5ec6479be17ec17686df0c1e2a3391fdd4c2 Mon Sep 17 00:00:00 2001
From: Ariadne Conill <ariadne@dereferenced.org>
Date: Sun, 3 Apr 2022 12:16:45 +0000
Subject: [PATCH 2/2] nslookup: sanitize all printed strings with
 printable_string

Otherwise, terminal sequences can be injected, which enables various terminal injection
attacks from DNS results.

Signed-off-by: Ariadne Conill <ariadne@dereferenced.org>

Upstream-Status: Backport [https://git.alpinelinux.org/aports/plain/main/busybox/0002-nslookup-sanitize-all-printed-strings-with-printable.patch]
CVE: CVE-2022-28391
Signed-off-by: Shubham Kulkarni <skulkarni@mvista.com>
---
 networking/nslookup.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/networking/nslookup.c b/networking/nslookup.c
index 3a614b0..c612535 100644
--- a/networking/nslookup.c
+++ b/networking/nslookup.c
@@ -401,7 +401,7 @@ static int parse_reply(const unsigned char *msg, size_t len)
				//printf("Unable to uncompress domain: %s\n", strerror(errno));
				return -1;
			}
-			printf(format, ns_rr_name(rr), dname);
+			printf(format, ns_rr_name(rr), printable_string(NULL, dname));
			break;

		case ns_t_mx:
@@ -416,7 +416,7 @@ static int parse_reply(const unsigned char *msg, size_t len)
				//printf("Cannot uncompress MX domain: %s\n", strerror(errno));
				return -1;
			}
-			printf("%s\tmail exchanger = %d %s\n", ns_rr_name(rr), n, dname);
+			printf("%s\tmail exchanger = %d %s\n", ns_rr_name(rr), n, printable_string(NULL, dname));
			break;

		case ns_t_txt:
@@ -428,7 +428,7 @@ static int parse_reply(const unsigned char *msg, size_t len)
			if (n > 0) {
				memset(dname, 0, sizeof(dname));
				memcpy(dname, ns_rr_rdata(rr) + 1, n);
-				printf("%s\ttext = \"%s\"\n", ns_rr_name(rr), dname);
+				printf("%s\ttext = \"%s\"\n", ns_rr_name(rr), printable_string(NULL, dname));
			}
			break;

@@ -458,7 +458,7 @@ static int parse_reply(const unsigned char *msg, size_t len)
				return -1;
			}

-			printf("\tmail addr = %s\n", dname);
+			printf("\tmail addr = %s\n", printable_string(NULL, dname));
			cp += n;

			printf("\tserial = %lu\n", ns_get32(cp));
--
2.7.4
