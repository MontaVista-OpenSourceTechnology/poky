From: Philip Withnall <pwithnall@endlessos.org>
Date: Wed, 10 Mar 2021 16:05:55 +0000
Subject: glocalfileoutputstream: Factor out a flag check

This clarifies the code a little. It introduces no functional changes.

Signed-off-by: Philip Withnall <pwithnall@endlessos.org>
Bug: https://gitlab.gnome.org/GNOME/glib/-/issues/2325
Bug-Debian: https://bugs.debian.org/984969
Origin: backport, commit:ce0eb088a68171eed3ac217cb92a72e36eb57d1b
Forwarded: https://gitlab.gnome.org/GNOME/glib/-/merge_requests/2002

Upstream-Status: Backport
CVE:  CVE-2021-28153 patch #4
Signed-off-by: Armin Kuster <akuster@mvista.com>

---
 gio/glocalfileoutputstream.c | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

Index: glib-2.58.0/gio/glocalfileoutputstream.c
===================================================================
--- glib-2.58.0.orig/gio/glocalfileoutputstream.c
+++ glib-2.58.0/gio/glocalfileoutputstream.c
@@ -757,6 +757,7 @@ handle_overwrite_open (const char    *fi
   int res;
   int mode;
   int errsv;
+  gboolean replace_destination_set = (flags & G_FILE_CREATE_REPLACE_DESTINATION);
 
   mode = mode_from_flags_or_info (flags, reference_info);
 
@@ -884,7 +885,7 @@ handle_overwrite_open (const char    *fi
    * to a backup file and rewrite the contents of the file.
    */
   
-  if ((flags & G_FILE_CREATE_REPLACE_DESTINATION) ||
+  if (replace_destination_set ||
       (!(original_stat.st_nlink > 1) && !is_symlink))
     {
       char *dirname, *tmp_filename;
@@ -903,7 +904,7 @@ handle_overwrite_open (const char    *fi
       
       /* try to keep permissions (unless replacing) */
 
-      if ( ! (flags & G_FILE_CREATE_REPLACE_DESTINATION) &&
+      if (!replace_destination_set &&
 	   (
 #ifdef HAVE_FCHOWN
 	    fchown (tmpfd, original_stat.st_uid, original_stat.st_gid) == -1 ||
@@ -1043,7 +1044,7 @@ handle_overwrite_open (const char    *fi
 	}
     }
 
-  if (flags & G_FILE_CREATE_REPLACE_DESTINATION)
+  if (replace_destination_set)
     {
       g_close (fd, NULL);
       
